{
  "id": "b2_ch2",
  "title": "第2章：隨機過程",
  "number": 2,
  "content": {
    "intro": {
      "title": "第 2 章：隨機過程 - 重點詳解 (Detail)",
      "roadmap": {
        "guide": "隨機過程是現代金融數學的靈魂。從馬可夫性質的「無記憶性」出發，本章帶領讀者一步步構建出描述金融市場價格波動的核心模型——幾何布朗運動（GBM）。",
        "objectives": "*   理解為何股票價格行為在馬可夫假設下符合弱式效率市場（Efficient Market Hypothesis）。\n*   掌握維納過程（$dz$）的三大特點：常態分佈、增量獨立、路徑連續。\n*   掌握伊藤引理——隨機微積分中的「連鎖規則」，這是推導 Black-Scholes 方程的必備工具。",
        "topics": "*   2.1 隨機變數與隨機過程 (Stochastic Process)\n*   2.2 馬可夫過程 (Markov Process)\n*   2.3 馬丁格爾 (Martingale) 平原理論\n*   2.4 隨機漫步 (Random Walk)\n*   2.5 維納過程 (Wiener Process)\n*   2.6 伊藤引理 (Itô's Lemma)\n*   2.7 幾何布朗運動 (Geometric Brownian Motion)"
      },
      "value": {
        "practical": "*   **實務場景**：利用 GBM 模擬未來一年的股票價格路徑，進行風險情境分析。\n*   **考試重點**：伊藤引理的公式應用：$df = (\\frac{\\partial f}{\\partial S} \\mu S + \\frac{\\partial f}{\\partial t} + \\frac{1}{2} \\frac{\\partial^2 f}{\\partial S^2} \\sigma^2 S^2) dt + \\frac{\\partial f}{\\partial S} \\sigma S dz$。",
        "theory": "在隨機微積分中，由於 $dz^2 = dt$，這個二階項必須保留。這就是為何衍生品價格的演化方程中會出現「凸性項」（$\\frac{1}{2} \\sigma^2 S^2 \\frac{\\partial^2 f}{\\partial S^2}$）。",
        "further_reading": "*   Hull (2021) Options, Futures, and Other Derivatives."
      },
      "implementation": {
        "python": "*   **GBM 模擬**：實作幾何布朗運動的離散形式 $S_{t+\\Delta t} = S_t \\exp((\\mu - \\frac{\\sigma^2}{2})\\Delta t + \\sigma \\sqrt{\\Delta t} Z)$。\n*   **可重複性**：使用 `np.random.seed()` 確保模擬結果的一致性，便於模型審核。\n*   **微小擾動法**：利用隨機路徑計算 Delta 希臘字母。",
        "logic": "*   馬可夫過程：未來僅取決於「現在」。\n*   馬丁格爾：公平博弈概念，折現預期等於當前值。",
        "scenarios": "| 腳本名稱 | 核心使命 |\n| :--- | :--- |\n| **B2_Ch2_1.py** | **[核心]** 實作幾何布朗運動 (GBM) 模擬與多路徑生成。 |\n| **B2_Ch2_2.py** | 演示基礎隨機過程數值運算與數據結構處理。 |\n| **B2_Ch2_3.py** | 隨機模擬中的偏誤校正與 NumPy 高效運算。 |\n| **B2_Ch2_4.py** | 蒙地卡羅路徑下的模型擬合與圖表分析。 |\n| **B2_Ch2_5.py** | 模擬路徑的統計特徵（均值、標準差）視覺化。 |\n| **B2_Ch2_6.py** | 演示多資產隨機路徑的並行視覺化佈局。 |\n| **B2_Ch2_7.py** | 進階隨機過程圖形繪製與風險敏感度呈現。 |\n| **B2_Ch2_8.py** | 演示隨機種子 (Random Seed) 的重要性與重複性驗證。 |\n| **B2_Ch2_9.py** | 利用隨機路徑計算 Delta 指標，分析波動率影響。 |"
      },
      "body": {
        "2.1": "### 2.1 隨機變數與隨機過程 (Stochastic Process)：從靜態快照到動態演化\n在金融風險架構中，單一隨機變數僅能描述某一特定時刻的狀態（如明日收盤價），而**隨機過程 (Stochastic Process)** 則是一系列隨時間演進的隨機變數家族 $\\{X_t, t \\in T\\}$。掌握其演化規律是從靜態會計思維邁向動態風險定價的關鍵轉折。\n\n#### 專家決策矩陣：隨機過程分類標準\n資深從業人員必須根據業務場景選擇合適的過程描述方式：\n\n| 分類維度 | 離散 (Discrete) | 連續 (Continuous) |\n| :--- | :--- | :--- |\n| **時間參數 ($T$)** | 每日收盤價序列、定期重新平衡 | 交易所盤中即時流、衍生品連續對沖 |\n| **狀態空間 ($S$)** | 漲跌點數、二元期權結果 | 股票價格、瞬時無風險利率 |\n| **實務選擇** | 適用於歷史回測與風險報告 | 適用於 Black-Scholes 定價與理論推導 |\n\n#### 技術分析：從隨機變數到序列特徵\n我們不再僅關心期望值 $E[X_t]$，更關心路徑的自相關性與方差的隨時間累積效應。金融時間序列的非平穩性通常要求我們對價格過程進行一階差分（回報率化）處理。\n\n> [!IMPORTANT]\n> 在生產系統中，所有離散取樣過程本質上都是對連續過程的近似。資深分析師必須意識到，取樣頻率的提高雖然能增加數據密度，但也可能引入微觀結構雜訊（Market Microstructure Noise）。\n\n#### 2.1 資深從業人員行動清單 (Action Items)\n啟動隨機路徑建模前，必須確認：\n- **定義域識別**：明確資產定價是基於離散交易日還是連續交易流。\n- **狀態空間劃分**：確認模型狀態是否需要進行邊界約束（如名目利率不為負）。\n- **數據清潔度檢核**：排除非交易時段產生的異常數據點，確保隨機過程的物理連貫性。\n\n#### 核心技術結論\n隨機過程是金融市場的數學底層。我們透過建立機率空間 $(\\Omega, \\mathcal{F}, P)$ 與資訊流（Filtration）濾過層次來精確描述不確定性的隨時間消散過程。",
        "2.2": "### 2.2 馬可夫過程 (Markov Process)：無記憶性的權威假設\n馬可夫性質 (Markov Property) 是現代金融模型的基石。它主張：**給定現在，未來與過去完全無關。** 這一假設不僅簡化了數學運算，更直接對應了弱式效率市場假說（EMH），即當前價格已反映所有歷史資訊。\n\n#### 專家定義：一階馬可夫性質\n對於隨機過程 $\\{X_t\\}$，其數學表達式如下：\n\n$$\n  P(X_{t+s} | X_t, X_{t-1}, ..., X_0) = P(X_{t+s} | X_t)\n$$\n\n#### 決策矩陣：馬可夫假設 vs. 市場現實\n在模型開發決策中，必須權衡假設的簡潔度與現實的複雜度：\n\n| 維度 | 馬可夫過程 | 具備記憶性過程 (如 ARMA) |\n| :--- | :--- | :--- |\n| **數學架構** | 極簡、支援遞迴解與 PDE | 複雜、需要儲存大量歷史狀態 |\n| **主要模型** | 布朗運動、幾何布朗運動 (GBM) | 分數布朗運動、含有長記憶的模型 |\n| **實務評價** | 衍生品定價的標準假設 | 適用於短期阿爾法 (Alpha) 挖掘 |\n| **核心侷限** | 無法捕捉波動聚集效應 | 計算成本隨歷史長度呈指數增長 |\n\n> [!IMPORTANT]\n> 在 Python 實作 Markov Chain 轉移矩陣（見 `B2_Ch2_2.py`）時，資業人員必須監控狀態轉移的收斂性。馬可夫性意味著我們無需追溯歷史路徑即可定義對沖策略。若檢測到顯著的序列相關性，則馬可夫假設失效，必須引入額外的參數狀態。\n\n#### 2.2 資深從業人員行動清單 (Action Items)\n應用馬可夫模型前，必須落實：\n- **獨立性校驗**：利用自相關函數 (ACF) 檢測回報率序列，確保顯著相關性僅限於當期。\n- **狀態定義審查**：確認當前「狀態」是否已包含所有足以決定未來的關鍵資訊。\n- **效率市場對標**：評估目標市場的資訊透明度，確保馬可夫無記憶假設不具備系統性偏差。\n\n#### 核心技術結論\n將市場價格視為馬可夫過程是量化金融的一大跨越。它將複雜的歷史追溯轉化為當下的分佈預測，為 Black-Scholes 及後續隨機模型奠定了理論合法性。",
        "2.3": "### 2.3 馬丁格爾 (Martingale) 平原理論：公平博弈與風險中性\n馬丁格爾在現代定價理論中代表了「無偏差預測」。在風險中性測度下，資產的預期回報率剛好等於無風險利率。這意味著在資訊流 $\\mathcal{F}_t$ 下，當下的折現價格是未來價格的最佳估計量。\n\n#### 專家定義：馬丁格爾條件\n一個隨機過程 $\\{M_t\\}$ 若滿足以下條件，則被稱為馬丁格爾：\n\n$$\n  E[M_{t+s} | \\mathcal{F}_t] = M_t\n$$\n\n#### 決策矩陣：馬丁格爾策略與實務陷阱\n理解馬丁格爾不僅是為了理論，更是為了識別交易系統中的致命風險：\n\n| 特性 | 標準馬丁格爾過程 | 馬丁格爾翻倍策略 (Gambler's Ruin) |\n| :--- | :--- | :--- |\n| **核心邏輯** | 無偏差隨機演化 | 輸後倍投以期待單次獲勝覆蓋虧損 |\n| **金融應用** | 風險中性定價、無套利證明 | 導致帳戶淨值在有限資金下趨於歸零 |\n| **風險特徵** | 方差隨時間漂移 | 具備極端的左尾風險（崩盤風險） |\n\n> [!WARNING]\n> 資深從業人員嚴禁在量化策略中引入馬丁格爾式的「攤平」邏輯（見 `B2_Ch2_4.py` 的蒙地卡羅模擬）。雖然理論上期望值不變，但在存在資金上限（Capital Constraint）的現實中，這必然導致 Ruin 結局。\n\n#### 2.3 資深從業人員行動清單 (Action Items)\n執行馬丁格爾定價前，必須確認：\n- **機率測度轉換**：確保已從主觀機率 (P-measure) 轉換至風險中性 (Q-measure)。\n- **折現鏈條完整性**：所有預期值計算必須搭配一致的時間折現因子。\n- **資本邊界審計**：監控策略最大回徹，確保不會因追求馬丁格爾回報而觸發清算紅線。\n\n#### 核心技術結論\n馬丁格爾平原保證了金融模型的「內部一致性」。透過構造馬丁格爾，我們得以為複雜衍生品獲取唯一的、無套利的公允價格。",
        "2.4": "### 2.4 隨機漫步 (Random Walk)：不確定性的物理原型\n隨機漫步 (Random Walk) 是布朗運動在離散時間下的表現形式，描述了一個在隨機衝擊驅動下演化的動力系統。在金融領域，這一模型被廣泛用於測試「價格行為是否具備可預測性」。\n\n#### 專家定義：離散步長模型\n對於一個標準對稱隨機漫步 $S_n$，其位置由獨立同分佈的增量 $X_i$ 決定：\n\n$$\n  S_n = \\sum_{i=1}^n X_i, \\quad X_i \\in \\{1, -1\\}\n$$\n\n#### 決策矩陣：隨機漫步 vs. 市場長期趨勢\n開發者必須識別隨機漫步模型在不同頻寬下的適用性：\n\n| 指標 | 純隨機漫步 (Pure RW) | 帶漂移隨機漫步 (RW with Drift) |\n| :--- | :--- | :--- |\n| **期望路徑** | 恆等於 0 (無偏) | 隨時間 $\\mu t$ 線性增長 |\n| **風險演化** | 方差隨時間 $n$ 線性增加 | 同左，方差與時間成正比 |\n| **金融意涵** | 無法解釋資產長期增長 | 符合股票長期正預期回報的特性 |\n| **適用場景** | 高頻隨機震盪模型 | 指數、藍籌股長期路徑模擬 |\n\n> [!IMPORTANT]\n> 在 **NumPy** 實作中（見 `B2_Ch2_5.py`），利用 `np.cumsum()` 能高效建構大規模隨機漫步。資深分析師必須意識到，雖然步長隨機，但系統的變異數 (Variance) 是隨時間確定性增長的。這意味著：預測時間越長，模型的置信區間 (Confidence Interval) 就越寬。\n\n#### 2.4 資深從業人員行動清單 (Action Items)\n執行隨機漫步模擬前，必須確認：\n- **增量分佈校準**：確認 $X_i$ 是服從二元分佈還是連續正態分佈。\n- **漂移項設定**：針對長期預測，必須引入 $\\mu$ (Drift) 以反映資本的風險補償。\n- **統計顯著性驗證**：對實測數據進行隨機性檢定 (Runs Test)，排除系統性的趨勢偏差。\n\n#### 核心技術結論\n隨機漫步是「醉漢的腳步」，雖然方向不可預知，但其擴散速度（方差）卻遵循嚴謹的統計律：$\\text{Risk} \\propto \\sqrt{\\text{Time}}$。這是理解金融風險如何隨時間「擴散」的初級物理解釋。",
        "2.5": "### 2.5 維納過程 (Wiener Process)：隨機微積分的原子\n維納過程 (Wiener Process)，亦稱標準布朗運動，是所有金融隨機微分方程 (SDE) 的物理動力源。它定義了一個在連續時間內運作、具備平滑擴散特徵的隨機底層。\n\n#### 專家定義：標準布朗運動三大公理\n一個過程 $W_t$ 被定義為維納過程，必須嚴格滿足：\n1.  **起點固定**：$W_0 = 0$ 具備確定性。\n2.  **增量獨立且正態**：對於任何 $s < t$，增量 $W_t - W_s \\sim N(0, t-s)$。\n3.  **路徑連續性**：路徑在任何時刻均連續，但處處不可微（不可導）。\n\n#### 決策矩陣：維納過程 vs. 跳躍過程 (Jump Diffusion)\n在特定市場環境下，必須決定驅動引擎的選型：\n\n| 特性 | 標準維納過程 ($dW$) | 泊松跳躍過程 (Jump) |\n| :--- | :--- | :--- |\n| **路徑特徵** | 連續且細碎的震盪 | 具備間歇性的突發跳空 |\n| **極端風險** | 忽略黑天鵝事件 | 專門描述極端突發事件 |\n| **數學難度** | 較低 (線性擴散) | 較高 (PIDE 偏積分微分方程) |\n| **主要用途** | 期權定價 (BS Model) | 信貸風險、能源市場定價 |\n\n> [!IMPORTANT]\n> 在生產端模擬時（見 `B2_Ch2_1.py`），離散化的維納增量 $dW = \\sqrt{dt} \\epsilon$ 必須配合高品質的高斯隨機數生成器。資深開發者必須確信模擬中的獨立性，任何偽隨機數的週期性特徵都可能導致大規模蒙地卡羅模擬的估計失效。\n\n#### 2.5 資深從業人員行動清單 (Action Items)\n佈署維納過程引擎前，必須確認：\n- **增量方差縮放**：嚴格執行 $\\sqrt{dt}$ 縮放因子，確保方差隨時間累積的物理一致性。\n- **隨機噴煙校驗**：監控模擬路徑的馬丁格爾特性，排除因代碼邏輯導致的非預期漂移。\n- **可重複性配置**：在生產環境中使用固定 `seed` 進行版本化風險分析，確保審計軌跡可追溯。\n\n#### 核心技術結論\n維納過程是隨機世界的「白噪聲累加器」。它將不確定性轉化為均勻擴散的機率流，為我們在連續時間下進行風險對沖提供了數學上的可能性。",
        "2.6": "### 2.6 伊藤引理 (Itô's Lemma)：隨機世界的連鎖法則\n伊藤引理是隨機微積分中最具震撼力的技術工具，被譽為「隨機世界的泰勒展開」。它揭示了在隨機環境下，非線性函數的變動量不僅取決於一階斜率，更受到二階波動項（凸性調整）的顯著驅動。\n\n#### 技術核心：伊藤公式 (Basic Formula)\n若 $S_t$ 遵循 $dS = a dt + b dW$，則對於函數 $f(S, t)$，其隨機演化方程為：\n\n$$\n  df = \\left( \\frac{\\partial f}{\\partial S}a + \\frac{\\partial f}{\\partial t} + \\mathbf{\\frac{1}{2} \\frac{\\partial^2 f}{\\partial S^2} b^2} \\right) dt + \\frac{\\partial f}{\\partial S}b dW\n$$\n\n#### 專家決策矩陣：伊藤微積分 vs. 普通微積分\n資深計量人員必須清楚為何無法在隨機環境下直接套用普通微積分：\n\n| 特徵 | 普通微積分 | 伊藤微積分 |\n| :--- | :--- | :--- |\n| **高階項處理** | $dx^2 \\to 0$ (被忽略) | $dW^2 = dt$ (必須保留) |\n| **鏈式法則** | $df = f'(x) dx$ | $df = f'(x) dx + \\frac{1}{2}f''(x) dx^2$ |\n| **物理意義** | 斜率決定變化 | **凸性 (Convexity)** 額外創造價值 |\n| **金融應用** | 靜態資產定價 | 期權定價 (Gamma 效應所在) |\n\n> [!IMPORTANT]\n> 在生產端計算 Gamma 與 Theta 關係時，伊藤引理提供的 $\\frac{1}{2}\\sigma^2 S^2 \\Gamma$ 項是維持 Delta 中性對沖成本的核心組成。忽略此項將導致對沖策略出現嚴重的系統性虧損。\n\n#### 2.6 資深從業人員行動清單 (Action Items)\n執行 Ito 轉換前，必須完成：\n- **偏導分析**：精確計算函數對時間 $t$ 與狀態 $S$ 的所有一二階偏導數。\n- **凸性代償檢查**：確保二階項 $\\frac{1}{2}f'' b^2$ 已正確整合進 $dt$ 項中，無一遺漏。\n- **維度校核**：確認所得隨機微分方程 (SDE) 的各項物理維度與原方程保持一致。\n\n#### 核心技術結論\n伊藤引理是連通「資產價格」與「衍生品價格」的橋樑。它正式定義了波動性是如何轉化為合約價值的，是所有衍生品定價模型的數學總綱。",
        "2.7": "### 2.7 幾何布朗運動 (Geometric Brownian Motion, GBM)：金融模擬的金標準\n幾何布朗運動 (GBM) 是現代資產價格路徑模擬的核心模型。它基於一個權威假設：資產的「百分比回報率」具備獨立同分佈特徵。這確保了模型生成的價格永遠為正，且分佈呈現完美的對數正態特徵。\n\n#### 專家定義：隨機微分方程 (SDE)\n股票價格 $S_t$ 的演化受控於漂移項 (Drift) 與波動項 (Volatility)：\n\n$$\n  dS_t = \\mu S_t dt + \\sigma S_t dW_t\n$$\n\n#### 技術推導：解析解與對數轉換\n透過對 $f(S) = \\ln(S)$ 套用伊藤引理，我們可以獲得用於生產模擬的閉式解：\n\n$$\n\\begin{aligned}\n  d(\\ln S) &= \\left( \\mu - \\frac{1}{2} \\sigma^2 \\right) dt + \\sigma dW_t \\\\\n  S_T &= S_0 \\exp\\left( \\left( \\mu - \\frac{1}{2} \\sigma^2 \\right)T + \\sigma W_T \\right)\n\\end{aligned}\n$$\n\n#### 決策矩陣：模型參數 $\\mu$ 與 $\\sigma$ 的決策策略\n資深分析師必須根據預測目標調整參數配置：\n\n| 分類 | $\\mu$ (漂移) 配置 | $\\sigma$ (波動) 配置 | 適用場景 |\n| :--- | :--- | :--- | :--- |\n| **現貨模擬** | 使用歷史平均回報或資本定價模型 (CAPM) | 使用預測 GARCH 波動率 | 真實情境分析、VaR 計算 |\n| **衍生品定價** | **強制等於 $r$ (無風險利率)** | 使用隱含波動率 (IV) | 期權估值、風險中性模擬 |\n\n> [!IMPORTANT]\n> 在 **Python** 部署中（見 `B2_Ch2_1.py`），離散化模擬公式 $S_{t+1} = S_t e^{(\\mu - 0.5\\sigma^2)dt + \\sigma \\sqrt{dt} Z}$ 是工業級路徑生成的金科玉律。它具備卓越的計算效率，且從根本上消除了離散算術模擬中可能出現的「股價負值」錯誤。\n\n#### 2.7 資深從業人員行動清單 (Action Items)\n執行 GBM 路徑生成前，必須確認：\n- **對數波動率調整**：確保已對漂移項進行了 $-0.5\\sigma^2$ 的 Jensen's Inequality 校準。\n- **路徑數量審計**：針對蒙地卡羅估值，路徑數量必須滿足收斂性要求（通常 $N > 10,000$）。\n- **分佈檢驗**：驗證生成路徑的終端分佈是否符合理論預期的 Lognormal 分佈。\n\n#### 核心技術結論\nGBM 是對效率市場最優雅的數學描述。它結合了趨勢與隨機衝擊，成為了構建 VaR、期權定價及資產配置模型的通用物理解法。"
      }
    },
    "examples": [
      {
        "id": "ex1",
        "title": "2.1 幾何布朗運動 (GBM) 多路徑模擬",
        "filename": "B2_Ch2_1.py",
        "code": "# B2_Ch2_1.py\nfrom matplotlib import pyplot as plt\nimport numpy as np\nimport pandas_datareader\n\n# simulation loop\nnp.random.seed(66)\ndef gbm(S,v,r,T):\n    return S * np.exp((r - 0.5 * v**2) * T + v * np.sqrt(T) * np.random.normal(0,1.0))\n\nS0, vol, mu, dt = 26.68, 0.8865, 0.35, 1/252\npath = []\nS = S0\nfor i in range(500):\n    S = gbm(S, vol, mu, dt)\n    path.append(S)\n\nplt.plot(path)\nplt.title('Simulated Stochastic Path (GBM)')\nplt.show()"
      },
      {
        "id": "ex2",
        "title": "2.2 隨機過程基礎數值運算",
        "filename": "B2_Ch2_2.py",
        "code": "import numpy as np\nI = np.matrix([[1, 0]])\nT = np.matrix([[.75, 0.25], [.65, 0.35]])\nfor i in range(3):\n    I = I * T\n    print(f'Day {i+1} Prob: {I}')"
      },
      {
        "id": "ex3",
        "title": "2.3 隨機模擬偏誤校正",
        "filename": "B2_Ch2_3.py",
        "code": "import numpy as np\nI = np.matrix([[0.5, 0.5]])\nT = np.matrix([[.75, 0.25], [.65, 0.35]])\nfor i in range(3):\n    I = I * T\n    print(f'Propagated Day {i+1}: {I}')"
      },
      {
        "id": "ex4",
        "title": "2.4 賭場策略蒙地卡羅分析",
        "filename": "B2_Ch2_4.py",
        "code": "import pandas as pd\nimport matplotlib.pyplot as plt \n# Martingale strategy simulation\nprofit, bet = 0, 1\nprofits = []\nfor i in range(10):\n    profit -= bet\n    bet *= 2\n    profits.append(profit)\nplt.bar(range(10), profits)\nplt.show()"
      },
      {
        "id": "ex5",
        "title": "2.5 隨機漫步統計特性",
        "filename": "B2_Ch2_5.py",
        "code": "import numpy as np\nimport matplotlib.pyplot as plt\nstep_num, path_num = 500, 10\nfor _ in range(path_num):\n    steps = np.random.choice([-1, 1], size=step_num)\n    path = np.cumsum(np.insert(steps, 0, 0))\n    plt.plot(path)\nplt.title('1D Random Walk')\nplt.show()"
      }
    ]
  }
}