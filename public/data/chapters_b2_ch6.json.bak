{
  "id": "b2_ch6",
  "title": "第6章：BSM選擇權定價",
  "number": 6,
  "content": {
    "intro": {
      "title": "第 6 章：BSM 選擇權定價 - 重點詳解 (Detail)",
      "roadmap": {
        "guide": "Black-Scholes-Merton 模型是現代金融理論的基石。本章深入探討 BSM 模型在不同資產類別（股票、外匯、期貨）上的應用，並探討了現金或無價值（Cash-or-Nothing）等奇異選擇權的定價邏輯。",
        "objectives": "*   掌握 BSM 模型中 $d_1$ 與 $d_2$ 的機率意義與計算。\n*   掌握常態分佈累積函數 $N(d_2)$ 在風險中性機率中的角色。\n*   理解外匯、期貨與股票選擇權定價公式在「持有成本」（Cost of Carry）上的細微差異。",
        "topics": "*   6.1 Black-Scholes-Merton (BSM) 模型\n*   6.2 時間價值 (Time Value) 與內在價值 (Intrinsic Value)\n*   6.3 嘉曼-科爾哈根模型 (Garman-Kohlhagen) 與外匯選擇權\n*   6.4 期貨選擇權 (Black 模型) 與債券選擇權\n*   6.5 數位選擇權 (Digital Options) / 二元選擇權"
      },
      "value": {
        "practical": "*   **實務場景**：在期權交易中，快速計算隱含波動率與理論價值的偏差。\n*   **考試重點**：掌握 BSM 模型的五大假設及其在極端市場（如黑天鵝事件）下的局限性。",
        "theory": "歐式看漲期權價格公式為：$C = S_0 N(d_1) - K e^{-rT} N(d_2)$。其中 $N(d_1)$ 是風險中性下的對沖比率，$N(d_2)$ 是到期時在價內 (ITM) 的機率。",
        "further_reading": "*   Black & Scholes (1973), Merton (1973) 原始論文。"
      },
      "implementation": {
        "python": "*   **解析解實作**：使用 `scipy.stats.norm` 實作標準 BSM 公式。\n*   **奇異選擇權**：實作 Cash-or-Nothing 與 Asset-or-Nothing 二元期權定價。\n*   **敏感度視覺化**：繪製標的價格、行權價與時間對期權價值的影響圖。",
        "logic": "*   持有成本 (Cost of Carry)：靈活應用於匯率、期貨與指數。\n*   數位收益：分析斷點式 Payoff 對風險管理的挑戰。",
        "scenarios": "| 腳本名稱 | 核心使命 |\n| :--- | :--- |\n| **B2_Ch6_1.py** | **[核心]** 實作歐式期權 Black-Scholes 解析解定價與圖表分析。 |\n| **B2_Ch6_2.py** | 演示標的價格變動對期權價值的非線性影響。 |\n| **B2_Ch6_3.py** | 利用二項樹模型輔助分析，演示 Delta 風險管理與離散對比。 |\n| **B2_Ch6_4.py** | 實作期權解析解公式，演示 SciPy 統計分佈函數的應用。 |\n| **B2_Ch6_5.py** | **[奇異]** 實作現金或無價值 (Cash-or-Nothing) 二元期權定價。 |\n| **B2_Ch6_6.py** | 演示波動率對期權價值的影響，繪製波動率 Vega 曲線。 |\n| **B2_Ch6_7.py** | **[奇異]** 實作資產或無價值 (Asset-or-Nothing) 期權定價。 |\n| **B2_Ch6_8.py** | 計算二元期權的 Delta 希臘字母與風險暴露特性。 |\n| **B2_Ch6_9.py** | 實作歐式期權 Delta 計算，演示風險對沖原型。 |\n| **B2_Ch6_10.py** | 實作資產或無價值二元期權解析定價，分析殖利率影響。 |"
      }
    },
    "body": {
      "6.1": "### 6.1 Black-Scholes-Merton (BSM) 模型：衍生品定價的物理學\\nBlack-Scholes-Merton (BSM) 模型是現代金融學的里程碑。它將期權定價從「直覺判斷」提升為「動態對沖」的精密科學。透過構造一個由股票與借貸組成的自我融資組合 (Self-financing Portfolio)，BSM 揭示了期權價格與風險中性期望值的內在聯繫。\\n\\n#### 專家定義：BSM 歐式定價公式 (Fixed)\\n歐式看漲期權 $C$ 的定價公式如下，這本質上是資產未來價值的風險中性期望值之折現：\\n\\n$$\\n  C = S_0 e^{-qT} N(d_1) - K e^{-rT} N(d_2)\\n$$\\n\\n其中關鍵參數 $d_1$ 與 $d_2$ 的定義為：\\n\\n$$\\n\\$$\n\\begin{aligned}\\n  d_1 &= \\frac{\\ln(S_0/K) + (r - q + \\sigma^2/2)T}{\\sigma \\sqrt{T}} \\\\\\n  d_2 &= d_1 - \\sigma \\sqrt{T}\\n\\end{aligned}\n$$\\n$$\\n\\n#### 專家決策矩陣：$N(d_1)$ 與 $N(d_2)$ 的決策含義\\n資深計量師不應僅將其視為公式，應深挖其風險管理內涵：\\n\\n| 組成項 | 統計意義 | 風險管理含義 |\\n| :--- | :--- | :--- |\\n| **$N(d_1)$** | 風險中性下的對沖權重 | **Delta**：維持 Delta 中性需持有標的資產的比例 |\\n| **$N(d_2)$** | 期權到期時在價內 (ITM) 的機率 | **機率測度**：執行期權的風險中性機率 |\\n| **$e^{-rT} K N(d_2)$** | 行權支出的期望現值 | 為了獲取資產而必須預留的現金儲備 |\\n\\n> [!IMPORTANT]\\n> 在生產端部署 BSM 模型時（見 `B2_Ch6_1.py`），資深分析師必須意識到 $q$ (持有成本) 的重要性。針對股指期權，$q$ 代表連續股息率；針對外匯期權，$q$ 代表外幣無風險利率。忽略 $q$ 將導致定價出現系統性高估。\\n\\n#### 6.1 資深從業人員行動清單 (Action Items)\\n執行 BSM 定價前，必須確認：\\n- **隱含參數合法性檢驗**：確保 $T > 0$ 且 $\\sigma > 0$，並檢查 $S_0, K$ 均為正值。\\n- **時間基數對齊**：利率 $r$ 與時間 $T$ 必須採用一致的複利與年度基數（通常為 365 天）。\\n- **邊界套利檢查**：計算出的 $C$ 必須滿足 $S_0 e^{-qT} - K e^{-rT} \\le C \\le S_0 e^{-qT}$ 的無套利空間。",
      "6.2": "### 6.2 時間價值 (Time Value) 與內在價值 (Intrinsic Value)\\n期權的公允價格由兩部分構成：**內在價值**與**時間價值**。資深從業人員透過拆解這兩部分，可以精確識別合約的獲利潛力與風險衰減（Time Decay）特徵。這是構建交易策略（如賣出偏度或買入波動率）的基礎。\\n\\n#### 技術核心：價值拆解模型\\n對於市價為 $C$ 的看漲期權，其構成如下：\\n- **內在價值 (Intrinsic Value)**：$\\max(S - K, 0)$。若立即行權能獲得的利潤。\\n- **時間價值 (Time Value)**：$C - \\max(S - K, 0)$。由於未來到期前價格可能繼續有利波動而產生的「溢價」。\\n\\n#### 專家決策矩陣：價值構成隨價位（Moneyness）的演化\\n資深分析師需監控不同價位下價值權重的變化：\\n\\n| 價位狀態 | 內在價值佔比 | 時間價值佔比 | 交易風險點 |\\n| :--- | :--- | :--- | :--- |\\n| **價外 (OTM)** | 0% | 100% | **Theta 殺傷力極強**：若行情不動，價值將歸零 |\\n| **平價 (ATM)** | 趨近 0% | **最大值** | **Gamma 風險高峰**：股價微動即導致 Delta 劇變 |\\n| **價內 (ITM)** | 佔主導 | 隨深度增加而遞減 | **Delta 趨近 1**：表現如同持有現貨 |\\n\\n> [!IMPORTANT]\\n> 隨者到期日的臨近，時間價值會呈現「加速度衰減」（見 `B2_Ch6_2.py`）。資深投資人嚴禁在到期日前一週大量持有 ATM 期權，因為此時的 Theta 衰減（Time Decay）會直接侵蝕資本，除非預期市場會發生極小機率的劇大波動。\\n\\n#### 6.2 資深從業人員行動清單 (Action Items)\\n分析期權價值組成時，必須：\\n- **獲利空間測算**：計算標的資產需波動多少百分比才能使 OTM 期權產生內在價值。\\n- **Theta/Vega 權衡**：在持有時間價值高的期權時，必須確認隱含波動率 (IV) 處於低位，以防止 Vega 與 Theta 的雙重打擊。\\n- **提前行權識別**：針對美式期權，當時間價值趨近 0 且內在價值高時，評估提前行權獲取利息的收益。",
      "6.3": "### 6.3 嘉曼-科爾哈根模型 (Garman-Kohlhagen) 與外匯選擇權\\n在跨國資產配置與匯率避險中，**Garman-Kohlhagen (GK)** 模型是關鍵的定價工具。它是 BSM 模型在外匯領域的直接延伸，其核心創新在於將「外幣」視為一個持續支付股息的資產，而「外幣利率」即為該資產的持有收益 (Yield)。\\n\\n#### 專家定義：GK 定價公式\\n考慮本幣利率 $r_d$ 與外幣利率 $r_f$，看漲外匯期權 $C$ 的價格為：\\n\\n$$\\n  C = S_0 e^{-r_f T} N(d_1) - K e^{-r_d T} N(d_2)\\n$$\\n\\n其中 $S_0$ 為當前匯率（單位本幣/單位外幣），參數 $d_1$ 的調整如下：\\n\\n$$\\n  d_1 = \\frac{\\ln(S_0/K) + (r_d - r_f + \\sigma^2/2)T}{\\sigma \\sqrt{T}}\\n$$\\n\\n#### 專家決策矩陣：兩國利率差對 IV 與定價的影響\\n資深分析師必須監控利率平價理論（IRP）對期權偏誤的影響：\\n\\n| 利率特徵 | 定義 ($r_d - r_f$) | 對遠期匯率影響 | 對 Call/Put 價值的偏好 |\\n| :--- | :--- | :--- | :--- |\\n| **本幣利率高** | 正價差 | 遠期匯率漲水 (Premium) | 推升 Call 價值，壓低 Put 價值 |\\n| **外幣利率高** | 負價差 | 遠期匯率貼水 (Discount) | 壓低 Call 價值，推升 Put 價值 |\\n| **利率趨同** | 零價差 | 遠期匯率等於現貨 | 定價趨於對稱 |\\n\\n> [!IMPORTANT]\\n> 在實施外匯期權對沖時（見 `B2_Ch6_4.py`），資深從業人員必須將 $r_f$ 視為對沖中外幣存款的利息收入。若忽略 $r_f$（將其設為 0），則會嚴重高估歐元、英鎊等高息貨幣期權的 Call 價值。\\n\\n#### 6.3 資深從業人員行動清單 (Action Items)\\n執行外匯期權定價前，必須確認：\\n- **兩國利率對應**：確保本幣利率 $(r_d)$ 與外幣利率 $(r_f)$ 的期限與期權到期日完全匹配。\\n- **隱含波動率選型**：確認 IV 是來自 OTC 市場的權威報價，並檢查是否存在顯著的波動率偏斜 (Skew)。\\n- **成本收益抵扣**：在風險報告中，明確列出因利率差導致的遠期對沖成本 (Swap Points)。",
      "6.4": "### 6.4 期貨選擇權 (Black 模型) 與債券選擇權：向 Black 模型轉換\\n在利率與大宗商品市場中，我們習慣對期貨價格進行建模，而非現貨價格。**Black 模型 (1976)** 是 BSM 模型針對期貨資產的權威修正。它將期貨價格作為標的，並隱含了期貨不需要支付「初始化持有成本」的物理特徵。\\n\\n#### 專家定義：Black 1976 公式\\n對於期貨價格 $F_0$，看漲期權價格如下：\\n\\n$$\\n  C = e^{-rT} [F_0 N(d_1) - K N(d_2)]\\n$$\\n\\n由於期貨的持有成本已反映在期貨價格中，其 $d_1$ 公式顯著簡化為：\\n\\n$$\\n  d_1 = \\frac{\\ln(F_0/K) + (\\sigma^2/2)T}{\\sigma \\sqrt{T}}\\n$$\\n\\n#### 專家決策矩陣：BSM 現貨模型 vs. Black 期貨模型\\n資深從業人員必須根據底層資產的合約形式選擇正確的模型：\\n\\n| 特性 | BSM 模型 (現貨) | Black 模型 (期貨) |\\n| :--- | :--- | :--- |\\n| **標的資產 $S$** | 市場即時現貨價 | 交易所掛牌期貨價 $F$ |\\n| **持有成本 $q$** | 需手動輸入股息、利率差等 | **自動歸零**：已隱含在期貨價格中 |\\n| **主要場景** | 個股、指數、外匯現貨 | 原油、黃金、國債、利率期貨 |\\n| **Delta 解釋** | 相對於現貨的敏感度 | 相對於期貨合約的敏感度 |\\n\\n> [!IMPORTANT]\\n> 在債券期權定價中（見 `B2_Ch6_9.py`），資深分析師必須使用 Black 模型。這是因為債券現貨存在複雜的應計利息 (Accrued Interest)，而債券期貨價格（乾價）更適合直接套用隨機過程。必須確保 $\\sigma$ 是「波動率的波動率」或標的期權的年度隱含波動率。\\n\\n#### 6.4 資深從業人員行動清單 (Action Items)\\n執行期貨期權分析時，必須落實：\\n- **到期日對齊**：確認期權到期日與標的期權合約最後交易日的時間差，這對 Theta 計算至關重要。\\n- **交割風險評估**：針對實物交割期貨，評估在期權到期後進入現貨交割的額外成本。\\n- **Gamma 激增監控**：期貨期權在到期前若深度 ATM，其 Delta 變動極快，必須執行高頻對沖基準測試。",
      "6.5": "### 6.5 數位選擇權 (Digital Options)：全有或全無的斷點風險\\n數位選擇權（亦稱二元選擇權，Binary Options）具備非連續的獲利結構。它不提供基於價格價差的線性收益，而是在滿足條件時支付固定金額 $Q$。這種「數位化」特性在行權價 $K$ 附近會產生極端的風險特徵，是資深風險官監控的重點。\\n\\n#### 技術核心：兩種主流數位期權\\n資長分析師必須精確區分以下兩種奇異收回結構：\\n\\n| 類型 | 獲利函數 (Payoff) | 定價核心公式 |\\n| :--- | :--- | :--- |\\n| **現金或無價值 (Cash-or-Nothing)** | 若 $S_T > K$，支付 $Q$；否則 0 | $C = Q e^{-rT} N(d_2)$ |\\n| **資產或無價值 (Asset-or-Nothing)** | 若 $S_T > K$，支付 $S_T$；否則 0 | $C = S_0 e^{-qT} N(d_1)$ |\\n\\n#### 專家決策矩陣：數位期權的希臘字母威脅\\n數位期權在 $S \\approx K$ 且 $T \\to 0$ 時會出現統計學上的災難：\\n\\n| 希臘字母 | 歐式標準期權 | 數位期權特徵 | 實務影響 |\\n| :--- | :--- | :--- | :--- |\\n| **Delta** | 有界且平滑 [0, 1] | **數值爆炸**：在 $K$ 處趨於無限大 | 對沖所需的現貨量在瞬間發生劇變 |\\n| **Gamma** | 鐘形曲線 | **極端波動**：符號會在 $K$ 兩側切換 | 靜態對沖幾乎不可能維持 |\\n| **Vega** | 正值 | 正負變換 | 隱含波動率的小幅上升可能導致價值反跌 |\\n\\n> [!IMPORTANT]\\n> 在生產端監控數位期權（見 `B2_Ch6_8.py`）時，嚴禁僅依賴解析 Delta。資深開發者會使用「滑動邊界」或「牛利價差 (Bull Spread)」來近似數位期權的對沖。這能有效平滑 $K$ 點附近的 Delta 峰值，防止對沖程序引發市場恐慌。\\n\\n#### 6.5 資深從業人員行動清單 (Action Items)\\n佈署數位期權前，必須落實：\\n- **對沖策略平滑化**：用一系列狹窄的看漲期權價差 (Call Spreads) 近似數位 Payoff，以降低單點風險。\\n- **間斷點壓力測試**：模擬標的價格在 $K$ 點上下 0.1% 波動時，Delta 的劇烈跳動範圍。\\n- **流動性準備金計提**：針對數位期權頭寸，計提額外的流動性風險準備金以應對潛在的巨大對沖覆蓋成本。\\n\\n#### 核心技術結論\\n數位期權是金融工程中的「震盪器」。掌握其底層 $N(d_2)$ 的定價邏輯，不僅能用於奇異產品估值，更是理解結構型商品中「觸碰即失效 (Knock-out)」條款的關鍵技術前提。"
    },
    "examples": [
      {
        "id": "ex1",
        "title": "B2_Ch6_1",
        "filename": "B2_Ch6_1.py",
        "code": "# B2_Ch6_1.py\n\n###############\n# Prepared by Ran An, Wei Lu, and Feng Zhang\n# Editor-in-chief: Weisheng Jiang, and Sheng Tu\n# Book 2  |  Financial Risk Management with Python\n# Published and copyrighted by Tsinghua University Press\n# Beijing, China, 2021\n###############\n\nimport matplotlib.pyplot as plt\nimport numpy as np\nfrom scipy.stats import norm\n\ndef option_analytical(S0, vol, r, q, t, K, PutCall):\n    d1 = (np.log(S0 / K) + (r - q + 0.5 * vol ** 2) * t) / (vol * np.sqrt(t))\n    d2 = (np.log(S0 / K) + (r - q - 0.5 * vol ** 2) * t) / (vol * np.sqrt(t))\n    price =  PutCall*S0 * np.exp(-q * t) * norm.cdf(PutCall*d1, 0.0, 1.0) - PutCall* K * np.exp(-r * t) * norm.cdf(PutCall*d2, 0.0, 1.0)  \n        \n    return price\n\n    # Inputs\nr = 0.03  #risk-free interest rate\nq = 0.0   # dividend yield\nvol = 0.5 #volatility\nt_base = 2.0\nPutCall = 1 # 1 for call;-1 for put\nspot = 50\nK = np.arange(20,80,1)  #strike price\n\nplt.figure(1)\nbs_price_call = option_analytical(spot, vol, r, q, t_base, K, PutCall =  1)\nplt.plot(K, bs_price_call, label='price')\nplt.xlabel(\"Strike price, K (USD)\")\nplt.ylabel(\"Euro call option price, C (USD)\")\nplt.gca().spines['right'].set_visible(False)\nplt.gca().spines['top'].set_visible(False)\nplt.grid(linestyle='--', axis='both', linewidth=0.25, color=[0.5,0.5,0.5])\nplt.gca().spines['right'].set_visible(False)\nplt.gca().spines['top'].set_visible(False)\n\nplt.figure(2)\nbs_price_put = option_analytical(spot, vol, r, q, t_base, K, PutCall =  -1)\nplt.plot(K, bs_price_put, label='price')\nplt.xlabel(\"Strike price, K (USD)\")\nplt.ylabel(\"Euro put option price, P (USD)\")\nplt.gca().spines['right'].set_visible(False)\nplt.gca().spines['top'].set_visible(False)\nplt.grid(linestyle='--', axis='both', linewidth=0.25, color=[0.5,0.5,0.5])"
      },
      {
        "id": "ex2",
        "title": "B2_Ch6_10",
        "filename": "B2_Ch6_10.py",
        "code": "# B2_Ch6_10.py\n\n###############\n# Prepared by Ran An, Wei Lu, and Feng Zhang\n# Editor-in-chief: Weisheng Jiang, and Sheng Tu\n# Book 2  |  Financial Risk Management with Python\n# Published and copyrighted by Tsinghua University Press\n# Beijing, China, 2021\n###############\n\nimport matplotlib.pyplot as plt\nimport numpy as np\nfrom scipy.stats import norm\n\ndef asset_or_nothing_analytical(S0, vol, r, q, t, K, PutCall):\n    if t == 0:\n        price =  S0*np.array(PutCall*(S0-K)>=0,dtype =bool)  \n    elif t > 0:\n        d1 = (np.log(S0 / K) + (r - q + 0.5 * vol ** 2) * t) / (vol * np.sqrt(t))       \n        price =  S0*np.exp(-q * t) * norm.cdf(PutCall*d1, 0.0, 1.0)      \n    else:\n        print(\"time to maturity should be greater or equal to zero\")\n    return price\n\n    # Inputs\nr = 0.085  #risk-free interest rate\nq = 0.0 # dividend yield\nK = 55   #strike price\nvol = 0.45 #volatility\nPutCall = 1 # 1 for call;-1 for put\nspot = np.arange(10,105,0.2)  #initial underlying asset price\nQ = K\nt = 0\n\nplt.figure(1)\nasset_or_nothing_call = asset_or_nothing_analytical(spot, vol, r, q, t, K, PutCall =  1)\nplt.plot(spot, asset_or_nothing_call, '.',label='price')\n\nplt.xlabel(\"Stock price, S (USD)\")\nplt.ylabel(\"Payoff at expiration\")\nplt.grid(linestyle='--', axis='both', linewidth=0.25, color=[0.5,0.5,0.5])\nplt.gca().spines['right'].set_visible(False)\nplt.gca().spines['top'].set_visible(False)\n\nplt.figure(2)\nasset_or_nothing_put = asset_or_nothing_analytical(spot, vol, r, q, t, K, PutCall =  -1)\nplt.plot(spot, asset_or_nothing_put, '.',label='price')\n\nplt.xlabel(\"Stock price, S (USD)\")\nplt.ylabel(\"Payoff at expiration\")\nplt.grid(linestyle='--', axis='both', linewidth=0.25, color=[0.5,0.5,0.5])\nplt.gca().spines['right'].set_visible(False)\nplt.gca().spines['top'].set_visible(False)\n\n"
      },
      {
        "id": "ex3",
        "title": "B2_Ch6_2",
        "filename": "B2_Ch6_2.py",
        "code": "# B2_Ch6_2.py\n\n###############\n# Prepared by Ran An, Wei Lu, and Feng Zhang\n# Editor-in-chief: Weisheng Jiang, and Sheng Tu\n# Book 2  |  Financial Risk Management with Python\n# Published and copyrighted by Tsinghua University Press\n# Beijing, China, 2021\n###############\n\nimport matplotlib.pyplot as plt\nimport numpy as np\nfrom scipy.stats import norm\n\ndef option_analytical(S0, vol, r, q, t, K, PutCall):\n    d1 = (np.log(S0 / K) + (r - q + 0.5 * vol ** 2) * t) / (vol * np.sqrt(t))\n    d2 = (np.log(S0 / K) + (r - q - 0.5 * vol ** 2) * t) / (vol * np.sqrt(t))\n    price =  PutCall*S0 * np.exp(-q * t) * norm.cdf(PutCall*d1, 0.0, 1.0) - PutCall* K * np.exp(-r * t) * norm.cdf(PutCall*d2, 0.0, 1.0)  \n        \n    return price\n\n    # Inputs\nr = 0.085  #risk-free interest rate\nq = 0.0 # dividend yield\nK = 55   #strike price\nvol = 0.45 #volatility\nt_base = 2.0\nPutCall = 1 # 1 for call;-1 for put\nspot = np.arange(0,100,1)  #initial underlying asset price\nt= np.arange(0.00001, 2, 0.25)\n\nNUM_COLORS = len(t)\ncm = plt.get_cmap('bwr')\ncm = plt.get_cmap('RdYlBu')\nfig1 = plt.figure(1)\nax = fig1.add_subplot(111)\n\nfor i in range(len(t)):\n    t_tmp = t[i]\n    bs_price_call = option_analytical(spot, vol, r, q, t_tmp, K, PutCall =  1)\n    lines = ax.plot(spot, bs_price_call, label='price')\n    lines[0].set_color(cm(i/NUM_COLORS))\n\nplt.xlabel(\"Stock price, S (USD)\")\nplt.ylabel(\"Euro call option price, C (USD)\")\nplt.gca().spines['right'].set_visible(False)\nplt.gca().spines['top'].set_visible(False)\nplt.grid(linestyle='--', axis='both', linewidth=0.25, color=[0.5,0.5,0.5])\nplt.gca().legend(['T = 0.00 Yr','T = 0.25 Yr','T = 0.50 Yr','T = 0.75 Yr','T = 1.00 Yr','T = 1.25 Yr','T = 1.50 Yr','T = 1.75 Yr'],loc='upper left')\n\nfig2 = plt.figure(2)\nax = fig2.add_subplot(111)\nfor i in range(len(t)):\n    t_tmp = t[i]\n    bs_price_put = option_analytical(spot, vol, r, q, t_tmp, K, PutCall =  -1)\n    lines = ax.plot(spot, bs_price_put, label='price')\n    lines[0].set_color(cm(i/NUM_COLORS))\n\nplt.xlabel(\"Stock price, S (USD)\")\nplt.ylabel(\"Euro put option price, P (USD)\")\nplt.gca().spines['right'].set_visible(False)\nplt.gca().spines['top'].set_visible(False)\nplt.grid(linestyle='--', axis='both', linewidth=0.25, color=[0.5,0.5,0.5])\nplt.gca().legend(['T = 0.00 Yr','T = 0.25 Yr','T = 0.50 Yr','T = 0.75 Yr','T = 1.00 Yr','T = 1.25 Yr','T = 1.50 Yr','T = 1.75 Yr'],loc='upper right')\n"
      },
      {
        "id": "ex4",
        "title": "B2_Ch6_3",
        "filename": "B2_Ch6_3.py",
        "code": "# B2_Ch6_3.py\n\n###############\n# Prepared by Ran An, Wei Lu, and Feng Zhang\n# Editor-in-chief: Weisheng Jiang, and Sheng Tu\n# Book 2  |  Financial Risk Management with Python\n# Published and copyrighted by Tsinghua University Press\n# Beijing, China, 2021\n###############\n\nimport matplotlib.pyplot as plt\nimport numpy as np\n\ndef Binomialtree(n, S0, K, r, q, vol, t, PutCall, EuropeanAmerican):  \n    deltaT = t/n \n    u = np.exp(vol*np.sqrt(deltaT))\n    d = 1./u\n    p = (np.exp((r-q)*deltaT)-d) / (u-d) \n    \n    #Binomial price tree\n    stockvalue = np.zeros((n+1,n+1))\n    stockvalue[0,0] = S0\n    for i in range(1,n+1):\n        stockvalue[i,0] = stockvalue[i-1,0]*u\n        for j in range(1,i+1):\n            stockvalue[i,j] = stockvalue[i-1,j-1]*d\n\n    #option value at final node   \n    optionvalue = np.zeros((n+1,n+1))\n    for j in range(n+1):\n        if PutCall==\"Call\": # Call\n            optionvalue[n,j] = max(0, stockvalue[n,j]-K)\n        elif PutCall==\"Put\": #Put\n            optionvalue[n,j] = max(0, K-stockvalue[n,j])\n    if deltaT != 0: \n    #backward calculation for option price    \n        for i in range(n-1,-1,-1):\n            for j in range(i+1):\n                if EuropeanAmerican==\"American\":\n                    if PutCall==\"Put\":\n                        optionvalue[i,j] = max(0, K-stockvalue[i,j], np.exp(-r*deltaT)*(p*optionvalue[i+1,j]+(1-p)*optionvalue[i+1,j+1]))\n                    elif PutCall==\"Call\":\n                        optionvalue[i,j] = max(0, stockvalue[i,j]-K, np.exp(-r*deltaT)*(p*optionvalue[i+1,j]+(1-p)*optionvalue[i+1,j+1]))\n                    else:\n                        print(\"PutCall type not supported\")\n                elif EuropeanAmerican==\"European\":    \n                    if PutCall==\"Put\":\n                        optionvalue[i,j] = max(0, np.exp(-r*deltaT)*(p*optionvalue[i+1,j]+(1-p)*optionvalue[i+1,j+1]))\n                    elif PutCall==\"Call\":\n                        optionvalue[i,j] = max(0, np.exp(-r*deltaT)*(p*optionvalue[i+1,j]+(1-p)*optionvalue[i+1,j+1]))\n                    else:\n                        print(\"PutCall type not supported\")\n                else:\n                    print(\"Excercise type not supported\")\n    else:\n        optionvalue[0,0] = optionvalue[n,j]\n        \n    return optionvalue[0,0] \n\n    # Inputs\nn = 50\nr = 0.085  #risk-free interest rate\nq = 0.0 # dividend yield\nK = 55   #strike price\nvol = 0.45 #volatility\nt_base = 2.0\nPutCall = 1 # 1 for call;-1 for put\nspot = np.arange(0,100,1)  #initial underlying asset price\n\nt= np.arange(0.00001, 2, 0.25)\nprice_call = np.zeros(len(spot)) \nprice_put = np.zeros(len(spot)) \n\nNUM_COLORS = len(t)\ncm = plt.get_cmap('RdYlBu')\nfig1 = plt.figure(1)\nax = fig1.add_subplot(111)\n\nfor i in range(len(t)):\n    t_tmp = t[i]\n    price_put = np.array([Binomialtree(n, S0, K, r, q, vol, t_tmp, PutCall=\"Put\", EuropeanAmerican=\"American\") for S0 in spot])\n    lines = ax.plot(spot, price_put, label='price')\n    lines[0].set_color(cm(i/NUM_COLORS))\n\nplt.xlabel(\"Stock price, S (USD)\")\nplt.ylabel(\"Am. put option price, P (USD)\")\nplt.gca().spines['right'].set_visible(False)\nplt.gca().spines['top'].set_visible(False)\nplt.grid(linestyle='--', axis='both', linewidth=0.25, color=[0.5,0.5,0.5])\nplt.gca().legend(['T = 0.00 Yr','T = 0.25 Yr','T = 0.50 Yr','T = 0.75 Yr','T = 1.00 Yr','T = 1.25 Yr','T = 1.50 Yr','T = 1.75 Yr'],loc='upper right')"
      },
      {
        "id": "ex5",
        "title": "B2_Ch6_4",
        "filename": "B2_Ch6_4.py",
        "code": "# B2_Ch6_3.py\n\n###############\n# Prepared by Ran An, Wei Lu, and Feng Zhang\n# Editor-in-chief: Weisheng Jiang, and Sheng Tu\n# Book 2  |  Financial Risk Management with Python\n# Published and copyrighted by Tsinghua University Press\n# Beijing, China, 2021\n###############\n\nimport numpy as np\nfrom scipy.stats import norm\n\ndef option_analytical(S0, vol, r_d, r_f, t, K, PutCall):\n    d1 = (np.log(S0 / K) + (r_d - r_f + 0.5 * vol ** 2) * t) / (vol * np.sqrt(t))\n    d2 = (np.log(S0 / K) + (r_d - r_f - 0.5 * vol ** 2) * t) / (vol * np.sqrt(t))  \n    price =  PutCall*S0 * np.exp(-r_f * t) * norm.cdf(PutCall*d1, 0.0, 1.0) - PutCall* K * np.exp(-r_d * t) * norm.cdf(PutCall*d2, 0.0, 1.0)  \n        \n    return price\n\n    # Inputs\nS0 = 1.6   # spot price, units of domestic currency of one unit of foreign currency\nr_d = 0.0606  # domestic risk-free interest rate\nr_f = 0.1168   # forieign risk-free interest rate \nK = 1.58    # strike price, units of domestic currency of one unit of foreign currency \nvol = 0.15    #volatility\nt = 90/365\nPutCall = -1 # 1 for call;-1 for put\n\nbs_price = option_analytical(S0, vol, r_d, r_f, t, K, PutCall)\nprint('analytical Price: %.4f' % bs_price)"
      },
      {
        "id": "ex6",
        "title": "B2_Ch6_5",
        "filename": "B2_Ch6_5.py",
        "code": "# B2_Ch6_5.py\n\n###############\n# Prepared by Ran An, Wei Lu, and Feng Zhang\n# Editor-in-chief: Weisheng Jiang, and Sheng Tu\n# Book 2  |  Financial Risk Management with Python\n# Published and copyrighted by Tsinghua University Press\n# Beijing, China, 2021\n###############\n\nimport matplotlib.pyplot as plt\nimport numpy as np\nfrom scipy.stats import norm\n\ndef cash_or_nothing_analytical(S0, vol, r, q, t, K, Q, PutCall):\n    if t == 0:\n        price =  Q*np.array(PutCall*(S0-K)>=0,dtype =bool)  \n    elif t > 0:\n        d2 = (np.log(S0 / K) + (r - q - 0.5 * vol ** 2) * t) / (vol * np.sqrt(t))\n       \n        price =  Q*np.exp(-r * t) * norm.cdf(PutCall*d2, 0.0, 1.0)      \n    else:\n        print(\"time to maturity should be greater or equal to zero\")\n    return price\n\n    # Inputs\nr = 0.085  #risk-free interest rate\nq = 0.0 # dividend yield\nK = 55   #strike price\nvol = 0.45 #volatility\nPutCall = 1 # 1 for call;-1 for put\nspot = np.arange(10,105,1)  #initial underlying asset price\nQ = 1\nt = 0\n\nplt.figure(1)\nprice_call = cash_or_nothing_analytical(spot, vol, r, q, t, K, Q, PutCall =  1)\nplt.plot(spot, price_call, '.',label='price')\n\nplt.xlabel(\"Stock price, S (USD)\")\nplt.ylabel(\"Payoff at expiration\")\nplt.grid(linestyle='--', axis='both', linewidth=0.25, color=[0.5,0.5,0.5])\nplt.gca().spines['right'].set_visible(False)\nplt.gca().spines['top'].set_visible(False)\n\nplt.figure(2)\nprice_put = cash_or_nothing_analytical(spot, vol, r, q, t, K, Q, PutCall =  -1)\nplt.plot(spot, price_put, '.',label='price')\n\nplt.xlabel(\"Stock price, S (USD)\")\nplt.ylabel(\"Payoff at expiration\")\nplt.grid(linestyle='--', axis='both', linewidth=0.25, color=[0.5,0.5,0.5])\nplt.gca().spines['right'].set_visible(False)\nplt.gca().spines['top'].set_visible(False)"
      },
      {
        "id": "ex7",
        "title": "B2_Ch6_6",
        "filename": "B2_Ch6_6.py",
        "code": "# B2_Ch6_6.py\n\n###############\n# Prepared by Ran An, Wei Lu, and Feng Zhang\n# Editor-in-chief: Weisheng Jiang, and Sheng Tu\n# Book 2  |  Financial Risk Management with Python\n# Published and copyrighted by Tsinghua University Press\n# Beijing, China, 2021\n###############\n\nimport matplotlib.pyplot as plt\nimport numpy as np\nfrom scipy.stats import norm\n\ndef option_analytical(S0, vol, r, q, t, K, PutCall):\n    d1 = (np.log(S0 / K) + (r - q + 0.5 * vol ** 2) * t) / (vol * np.sqrt(t))\n    d2 = (np.log(S0 / K) + (r - q - 0.5 * vol ** 2) * t) / (vol * np.sqrt(t))\n    price =  PutCall*S0 * np.exp(-q * t) * norm.cdf(PutCall*d1, 0.0, 1.0) - PutCall* K * np.exp(-r * t) * norm.cdf(PutCall*d2, 0.0, 1.0)  \n        \n    return price\n\n    # Inputs\nr = 0.085  #risk-free interest rate\nq = 0.0 # dividend yield\nK = 55   #strike price\nvol = 0.45 #volatility\nPutCall = 1 # 1 for call;-1 for put\nspot = np.arange(10,105,0.2)  #initial underlying asset price\nQ = 1\nt = 0\nEPSILO = 0.01*K\nN = 0.5*Q/EPSILO \nEPSILON = np.arange(0.005,0.2,0.025)*K\n\nNUM_COLORS = len(EPSILON )\ncm = plt.get_cmap('RdYlBu')\nfig1 = plt.figure(1)\nax = fig1.add_subplot(111)\n\nfor i in range(len(EPSILON)):\n    EPSILON_tmp = EPSILON[i]\n    european_call_K1 = option_analytical(spot, vol, r, q, t, K-EPSILON_tmp, PutCall =  1)\n    european_call_K2 = option_analytical(spot, vol, r, q, t, K+EPSILON_tmp, PutCall =  1)\n    N_tmp = 0.5*Q/EPSILON_tmp \n    lines = ax.plot(spot, N_tmp*european_call_K1-N_tmp*european_call_K2,label='price')\n    lines[0].set_color(cm(i/NUM_COLORS))\nplt.xlabel(\"Stock price, S (USD)\")\nplt.ylabel(\"Payoff at expiration\")\nplt.grid(linestyle='--', axis='both', linewidth=0.25, color=[0.5,0.5,0.5])\nplt.gca().spines['right'].set_visible(False)\nplt.gca().spines['top'].set_visible(False)\nplt.gca().legend(['e = 0.275','e = 1.65','e = 3.025','e = 4.4','e = 5.775','e = 7.15','e = 8.525','e = 9.9'],loc='upper left')\n\nfig2 = plt.figure(2)\nax = fig2.add_subplot(111)\n\nfor i in range(len(EPSILON)):\n    EPSILON_tmp = EPSILON[i]\n    european_put_K1 = option_analytical(spot, vol, r, q, t, K+EPSILON_tmp, PutCall =  -1)\n    european_put_K2 = option_analytical(spot, vol, r, q, t, K-EPSILON_tmp, PutCall =  -1)\n    N_tmp = 0.5*Q/EPSILON_tmp \n    lines = ax.plot(spot, N_tmp*european_put_K1-N_tmp*european_put_K2,label='price')\n    lines[0].set_color(cm(i/NUM_COLORS))\nplt.xlabel(\"Stock price, S (USD)\")\nplt.ylabel(\"Payoff at expiration\")\nplt.grid(linestyle='--', axis='both', linewidth=0.25, color=[0.5,0.5,0.5])\nplt.gca().spines['right'].set_visible(False)\nplt.gca().spines['top'].set_visible(False)\nplt.gca().legend(['e = 0.275','e = 1.65','e = 3.025','e = 4.4','e = 5.775','e = 7.15','e = 8.525','e = 9.9'],loc='upper right')"
      },
      {
        "id": "ex8",
        "title": "B2_Ch6_7",
        "filename": "B2_Ch6_7.py",
        "code": "# B2_Ch6_7.py\n\n###############\n# Prepared by Ran An, Wei Lu, and Feng Zhang\n# Editor-in-chief: Weisheng Jiang, and Sheng Tu\n# Book 2  |  Financial Risk Management with Python\n# Published and copyrighted by Tsinghua University Press\n# Beijing, China, 2021\n###############\n\nimport matplotlib.pyplot as plt\nimport numpy as np\nfrom scipy.stats import norm\n\ndef cash_or_nothing_analytical(S0, vol, r, q, t, K, Q, PutCall):\n    if t == 0:\n        price =  Q*np.array(S0>=K,dtype =bool)  \n    elif t > 0:\n        d2 = (np.log(S0 / K) + (r - q - 0.5 * vol ** 2) * t) / (vol * np.sqrt(t))\n       \n        price =  Q*np.exp(-r * t) * norm.cdf(PutCall*d2, 0.0, 1.0)      \n    else:\n        print(\"time to maturity should be greater or equal to zero\")\n    return price\n\n    # Inputs\nr = 0.085  #risk-free interest rate\nq = 0.0 # dividend yield\nK = 55   #strike price\nvol = 0.45 #volatility\nt_base = 2.0\nPutCall = 1 # 1 for call;-1 for put\nspot = np.arange(20,95,1)  #initial underlying asset price\nQ = 10\nt= np.arange(1/12, 1, 1/12)\n\nNUM_COLORS = len(t)\ncm = plt.get_cmap('RdYlBu')\nfig1 = plt.figure(1)\nax = fig1.add_subplot(111)\n\nfor i in range(len(t)):\n    t_tmp = t[i]\n    price_call = cash_or_nothing_analytical(spot, vol, r, q, t_tmp, K, Q, PutCall =  1)\n    lines = ax.plot(spot, price_call, label='price')\n    lines[0].set_color(cm(i/NUM_COLORS))\n\nplt.xlabel(\"Asset price, S (USD)\")\nplt.ylabel(\"Cash-or-nothing call option price (USD)\")\nplt.gca().spines['right'].set_visible(False)\nplt.gca().spines['top'].set_visible(False)\nplt.grid(linestyle='--', axis='both', linewidth=0.25, color=[0.5,0.5,0.5])\nplt.gca().legend(['T = 1/12 Yr','T = 2/12 Yr','T = 3/12 Yr','T = 4/12 Yr','T = 5/12 Yr','T = 6/12 Yr','T = 7/12 Yr','T = 8/12 Yr','T = 9/12 Yr','T = 10/12 Yr','T = 11/12 Yr'],loc='upper left')\n\nfig2 = plt.figure(2)\nax = fig2.add_subplot(111)\nfor i in range(len(t)):\n    t_tmp = t[i]\n    price_put = cash_or_nothing_analytical(spot, vol, r, q, t_tmp, K, Q, PutCall =  -1)\n    lines = ax.plot(spot, price_put, label='price')\n    lines[0].set_color(cm(i/NUM_COLORS))\n\nplt.xlabel(\"Asset price, S (USD)\")\nplt.ylabel(\"Cash-or-nothing put option price (USD)\")\nplt.gca().spines['right'].set_visible(False)\nplt.gca().spines['top'].set_visible(False)\nplt.grid(linestyle='--', axis='both', linewidth=0.25, color=[0.5,0.5,0.5])\nplt.gca().legend(['T = 1/12 Yr','T = 2/12 Yr','T = 3/12 Yr','T = 4/12 Yr','T = 5/12 Yr','T = 6/12 Yr','T = 7/12 Yr','T = 8/12 Yr','T = 9/12 Yr','T = 10/12 Yr','T = 11/12 Yr'],loc='upper right')\n"
      },
      {
        "id": "ex9",
        "title": "B2_Ch6_8",
        "filename": "B2_Ch6_8.py",
        "code": "# B2_Ch6_8.py\n\n###############\n# Prepared by Ran An, Wei Lu, and Feng Zhang\n# Editor-in-chief: Weisheng Jiang, and Sheng Tu\n# Book 2  |  Financial Risk Management with Python\n# Published and copyrighted by Tsinghua University Press\n# Beijing, China, 2021\n###############\n\nimport matplotlib.pyplot as plt\nimport numpy as np\nfrom scipy.stats import norm\n\ndef cash_or_nothing_delta(S0, vol, r, q, t, K, Q, PutCall):\n    d2 = (np.log(S0 / K) + (r - q - 0.5 * vol ** 2) * t) / (vol * np.sqrt(t))\n    delta =  PutCall*Q*np.exp(-r * t) * norm.pdf(PutCall*d2, 0.0, 1.0) / (vol*S0*np.sqrt(t))    \n    return delta\n\n    # Inputs\nr = 0.01  #risk-free interest rate\nq = 0.0 # dividend yield\nK = 55   #strike price\nvol = 0.45 #volatility\nt_base = 2.0\nPutCall = 1 # 1 for call;-1 for put\nspot = np.arange(20,95,0.5)  #initial underlying asset price\nQ = 10\nt= np.arange(1/365, 1, 2/12)\n\nNUM_COLORS = len(t)\ncm = plt.get_cmap('RdYlBu')\nfig1 = plt.figure(1)\nax = fig1.add_subplot(111)\n\nfor i in range(len(t)):\n    t_tmp = t[i]\n    delta_call = cash_or_nothing_delta(spot, vol, r, q, t_tmp, K, Q, PutCall =  1)\n    lines = ax.plot(spot, delta_call,label='delta')\n    lines[0].set_color(cm(i/NUM_COLORS))\n\nplt.xlabel(\"Asset price, S (USD)\")\nplt.ylabel(\"Cash-or-nothing call option delta (USD)\")\nplt.gca().spines['right'].set_visible(False)\nplt.gca().spines['top'].set_visible(False)\nplt.grid(linestyle='--', axis='both', linewidth=0.25, color=[0.5,0.5,0.5])\nplt.gca().legend(['T=1/365 Yr','T=2/12 Yr','T=4/12 Yr','T=6/12 Yr','T=8/12 Yr','T=10/12 Yr'],loc='upper left')\n\nfig2 = plt.figure(2)\nax = fig2.add_subplot(111)\nfor i in range(len(t)):\n    t_tmp = t[i]\n    delta_put = cash_or_nothing_delta(spot, vol, r, q, t_tmp, K, Q, PutCall =  -1)\n    lines = ax.plot(spot, delta_put, label='delta')\n    lines[0].set_color(cm(i/NUM_COLORS))\n\nplt.xlabel(\"Asset price, S (USD)\")\nplt.ylabel(\"Cash-or-nothing put option delta (USD)\")\nplt.gca().spines['right'].set_visible(False)\nplt.gca().spines['top'].set_visible(False)\nplt.grid(linestyle='--', axis='both', linewidth=0.25, color=[0.5,0.5,0.5])\nplt.gca().legend(['T=1/365 Yr','T=2/12 Yr','T=4/12 Yr','T=6/12 Yr','T=8/12 Yr','T=10/12 Yr'],loc='lower left')"
      },
      {
        "id": "ex10",
        "title": "B2_Ch6_9",
        "filename": "B2_Ch6_9.py",
        "code": "# B2_Ch6_9.py\n\n###############\n# Prepared by Ran An, Wei Lu, and Feng Zhang\n# Editor-in-chief: Weisheng Jiang, and Sheng Tu\n# Book 2  |  Financial Risk Management with Python\n# Published and copyrighted by Tsinghua University Press\n# Beijing, China, 2021\n###############\n\nimport matplotlib.pyplot as plt\nimport numpy as np\nfrom scipy.stats import norm\n\ndef option_delta(S0, vol, r, q, t, K, PutCall):\n    d1 = (np.log(S0 / K) + (r - q + 0.5 * vol ** 2) * t) / (vol * np.sqrt(t))\n    if PutCall == 1:\n        delta = np.exp(-q * t) * norm.cdf(d1, 0.0, 1.0)\n    else:    \n        delta = np.exp(-q * t) * (norm.cdf(d1, 0.0, 1.0) -1 )\n        \n    return delta\n    # Inputs\nr = 0.01  #risk-free interest rate\nq = 0.0 # dividend yield\nK = 55   #strike price\nvol = 0.45 #volatility\nt_base = 2.0\nPutCall = 1 # 1 for call;-1 for put\nspot = np.arange(20,95,0.5)  #initial underlying asset price\nQ = 10\nt= np.arange(1/365, 1, 2/12)\n\nEPSILO = 0.05*K\nN = 0.5*Q/EPSILO \nNUM_COLORS = len(t)\ncm = plt.get_cmap('RdYlBu')\nfig1 = plt.figure(1)\nax = fig1.add_subplot(111)\n\nfor i in range(len(t)):\n    t_tmp = t[i]\n    delta_call_K1 = option_delta(spot, vol, r, q, t_tmp, K - EPSILO, PutCall =  1)\n    delta_call_K2 = option_delta(spot, vol, r, q, t_tmp, K + EPSILO, PutCall =  1)\n    lines = ax.plot(spot, N*(delta_call_K1 - delta_call_K2)  ,label='delta')\n    lines[0].set_color(cm(i/NUM_COLORS))\n\nplt.xlabel(\"Asset price, S (USD)\")\nplt.ylabel(\"replicating Cash-or-nothing call option delta (USD)\")\nplt.grid(linestyle='--', axis='both', linewidth=0.25, color=[0.5,0.5,0.5])\nplt.gca().spines['right'].set_visible(False)\nplt.gca().spines['top'].set_visible(False)\nplt.gca().legend(['T=1/365 Yr','T=2/12 Yr','T=4/12 Yr','T=6/12 Yr','T=8/12 Yr','T=10/12 Yr'],loc='upper left')\n\nfig2 = plt.figure(2)\nax = fig2.add_subplot(111)\n\nfor i in range(len(t)):\n    t_tmp = t[i]\n    delta_put_K1 = option_delta(spot, vol, r, q, t_tmp, K + EPSILO, PutCall =  -1)\n    delta_put_K2 = option_delta(spot, vol, r, q, t_tmp, K - EPSILO, PutCall =  -1)\n    lines = ax.plot(spot, N*(delta_put_K1 - delta_put_K2), label='delta')\n    lines[0].set_color(cm(i/NUM_COLORS))\n\nplt.xlabel(\"Asset price, S (USD)\")\nplt.ylabel(\"replicating Cash-or-nothing put option delta (USD)\")\nplt.grid(linestyle='--', axis='both', linewidth=0.25, color=[0.5,0.5,0.5])\nplt.gca().spines['right'].set_visible(False)\nplt.gca().spines['top'].set_visible(False)\nplt.gca().legend(['T=1/365 Yr','T=2/12 Yr','T=4/12 Yr','T=6/12 Yr','T=8/12 Yr','T=10/12 Yr'],loc='lower left')\n"
      }
    ]
  }
}