{
  "id": "b2_ch10",
  "title": "第10章：交易對手信用風險",
  "number": 10,
  "content": {
    "intro": {
      "title": "第 10 章：交易對手信用風險 - 重點詳解 (Detail)",
      "roadmap": {
        "guide": "交易對手信用風險（CCR）是衍生品市場中特有的風險。與傳統債券信用風險不同，CCR 的風險曝露（Exposure）具有隨機性且雙向變動。本章深入探討如何利用蒙地卡羅模擬與金融工程模型，量化交易對手違約帶來的潛在隨機損失，並介紹了 CVA 的計算。",
        "objectives": "*   理解為何衍生品的信用曝露是雙向且隨機的。\n*   掌握預期曝露 (EE) 與潛在未來曝露 (PFE) 的計算邏輯與置信水平。\n*   掌握 CVA 的定價公式及其在無風險中性下的對沖意義。",
        "topics": "*   10.1 交易對手信用風險 (CCR) 核心概念\n*   10.2 交易對手信用風險度量與模型\n*   10.3 預期正曝露 (EE) 與最大潛在未來風險曝露 (PFE)\n*   10.4 遠期合約 (Forwards) 的交易對手信用風險\n*   10.5 利率互換 (IRS) 的交易對手信用風險\n*   10.6 貨幣互換 (CIRS) 的交易對手信用風險\n*   10.7 信用風險緩釋 (Mitigation)：淨額結算與抵押品\n*   10.8 信用估值調整 (CVA) 與定價\n*   10.9 錯向風險 (Wrong-Way Risk) 分析"
      },
      "value": {
        "practical": "*   **實務場景**：計算利率互換 (IRS) 的 CVA 費用，將信用溢價包含在合約定價中（XVA 管理）。\n*   **考試重點**：理解 EE 曲線的形狀如何受合約到期時間與均值回歸特性的影響。",
        "theory": "CCR 的風險曝露隨機且雙向。EE (Expected Exposure) 用於計算 CVA，而 PFE (Potential Future Exposure) 用於信用額度管理。CVA 是衍生品公平價值與無違約價值之間的差額。",
        "further_reading": "*   Gregory (2012) Counterparty Credit Risk and Credit Value Adjustment."
      },
      "implementation": {
        "python": "*   **隨機模擬**：使用 `QuantLib` 與 `numpy` 進行路徑演化模擬。\n*   **曲線提取**：在每個時間點計算分位數（Percentile）以得到 PFE 曲線。\n*   **CVA 計算**：結合折扣因子與違約機率曲線實作 CVA 求和公式。",
        "logic": "*   EE vs PFE：平均值 vs 高置信度閾值。\n*   CVA：信用估值調整的精算模型。",
        "scenarios": "| 腳本名稱 | 核心使命 |\n| :--- | :--- |\n| **B2_Ch10_1.py** | 定義機率密度函數 (PDF) 圖表繪製與統計特徵分析。 |\n| **B2_Ch10_2.py** | 演示多子圖佈局在風險數據分佈對比中的應用。 |\n| **B2_Ch10_3.py** | 視覺化呈現統計分佈函數曲線，描述基礎風險因子特徵。 |\n| **B2_Ch10_4.py** | 演示數據直方圖與機率密度曲線的擬合優度視覺化。 |\n| **B2_Ch10_5.py** | **[核心]** 利用 QuantLib 進行蒙地卡羅模擬，分析隨機過程的路徑演化與 EE/PFE 指標。 |\n| **B2_Ch10_6.py** | 演示偏態與峰態對風險分佈圖形的影響及其統計意義。 |"
      }
    },
    "body": {
      "10.1": "### 10.1 交易對手信用風險 (CCR) 核心概念：雙向與隨機的博弈\n與傳統貸款不同，交易對手信用風險 (Counterparty Credit Risk, CCR) 是衍生品交易中特有的風險。其核心特徵在於風險曝露 (Exposure) 是**雙向的**且**隨機的**。資深衍生品交易員必須意識到，即便在交易初期 MtM 為零，隨著市場波動，未來的信用敞口可能會急劇擴大，形成「未被抵押」的潛在損失來源。\n\n#### 專家決策矩陣：傳統信用風險 vs. 交易對手信用風險\n資深計量師必須識別兩者在風險建模上的本質差異：\n\n| 特性 | 傳統貸款信用風險 | 交易對手信用風險 (CCR) |\n| :--- | :--- | :--- |\n| **風險曝露 (EAD)** | 確定的（本金金額） | **隨機的**：隨標的市場價格波動 |\n| **方向性** | 單向：銀行借錢給客戶 | **雙向**：MtM 可能為正或負，視誰欠誰錢 |\n| **風險緩釋** | 抵押品、保證人 | 淨額結算 (Netting)、保證金 (CSA) |\n| **違約關聯** | 獨立居多 | **錯向風險 (Wrong-Way Risk)**：市場波動與違約正相關 |\n\n#### 技術核心：MtM 的動態演化\nCCR 的本質是「當交易對手違約時，我方處於價內 (ITM) 的潛在價值」。若 MtM 為負（我方欠對方錢），則對我方而言不存在信用風險，因為對方違約對我方反而可能有潛在收益（視法律淨額規定而定）。\n\n> [!IMPORTANT]\n> 在生產端監控 CCR 時（見 `B2_Ch10_1.py`），資深開發者會使用 `scipy.stats.norm` 模擬 MtM 的分佈。必須注意，對沖 CCR 的成本（即 CVA）應被計入衍生品的成交價中，否則銀行將在每次成交時隱性地「贈送」信用保險給交易對手。\n\n#### 10.1 資深從業人員行動清單 (Action Items)\n執行 CCR 評估前，必須確認：\n- **淨額結算協議 (ISDA Master) 審計**：確認交易對手是否簽署了具備法律效力的淨額結算協議，這能直接降低 80% 以上的名目曝露。\n- **產品維度映射**：識別哪些產品具備「負凸性」風險曝露（如外匯掉期），其在極端行情下的 EAD 增長速度遠高於線性產品。\n- **保證金條款對位**：檢查 CSA 協議中的閾值 (Threshold) 與最低轉移金額 (MTA)，這決定了風險曝露的「非對沖上限」。",
      "10.2": "### 10.2 交易對手信用風險度量與模型：隨機路徑的統計解碼\n度量 CCR 的難點在於其「路徑依賴性」。資深從業人員不再使用靜態的數值，而是使用一條隨時間變化的**曝露曲線 (Exposure Profile)**。這需要透過蒙地卡羅模擬（Monte Carlo Simulation）生成數萬條標的價格路徑，並在每個時間點重新對整個衍生品組合進行估值 (Repricing)。\n\n#### 技術核心：曝露分位數定義\n在每個模擬時點 $t$，我們獲取 MtM 的分佈，並提取以下核心指標：\n- **當前曝露 (Current Exposure)**：$\\max(V, 0)$。目前的即時損失風險。\n- **預期曝露 (EE)**：所有大於 0 的 MtM 之機率加權平均值。用於計算 CVA。\n- **潛在未來曝露 (PFE)**：在特定置信水平（如 95% 或 99%）下的最大可能曝露。用於限額控管。\n\n#### 專家決策矩陣：風險度量指標的選擇\n資深風險官根據管理目的選取指標：\n\n| 指標 | 數據性質 | 應用決策 |\n| :--- | :--- | :--- |\n| **預期正曝露 (EE)** | 平均值概念 | **定價決策**：計算信用溢價與 CVA 費用 |\n| **PFE (95%)** | 高置信度閾值 | **額度核貸**：確保極端情況下不會穿透交易限額 |\n| **預期最大曝露 (EPE)** | EE 在合適時間內的均值 | **資本計提**：巴塞爾協議計算 RWA 的輸入 |\n\n> [!IMPORTANT]\n> 在使用 `numpy` 進行矩陣運算時（見 `B2_Ch10_2.py`），資深開發者會使用分頁式存儲來處理海量的模擬路徑數據。必須警惕「模型漂移」：若標的資產的波動率 $\\sigma$ 被低估，生成的 PFE 曲線將無法覆蓋實際的極端變動，導致限額管理失效。\n\n#### 10.2 資深從業人員行動清單 (Action Items)\n執行模型校準時，必須落實：\n- **模擬頻率優化**：針對長期互換合約，確保前期採樣點足夠密集，以捕捉「提前提前行權」或「波幅擴張」初期的劇烈變動。\n- **相關性矩陣回測**：在多資產路徑模擬中，必須定期回測資產間的相關係數，防止在「風險公因數」激增時低估總曝露。\n- **路徑數量敏感度測試**：測試 $N$ 次模擬下 EE 值的穩定度。若 $N=5,000$ 與 $N=10,000$ 的差異超過 5%，則必須增加模擬次數。",
      "10.3": "### 10.3 預期正曝露 (EE) 與潛在未來風險曝露 (PFE)\n這是 CCR 兩大核心監控維度。**預期正曝露 (Expected Exposure, EE)** 是計算信用成本的「精算底數」，而**潛在未來風險曝露 (Potential Future Exposure, PFE)** 則是限額管理的「防禦紅線」。資深從業人員透過對比這兩條曲線，可以洞察資產組合在生命週期內的風險演化特徵。\n\n#### 專家定義：EE 與 PFE 的數學關係\n假設在時間 $t$ 衍生品價值為 $V_t$，分佈為 $f(V_t)$：\n\n$$\n  EE(t) = \\int_0^{\\infty} V_t f(V_t) dV_t, \\quad PFE_{\\alpha}(t) = \\inf \\{ x : P(V_t > x) \\le 1-\\alpha \\}\n$$\n\n#### 專家決策矩陣：不同合約的曝露曲線形態\n資深分析師必須根據合約性質預判曲線走向：\n\n| 合約類型 | 曲線形態 (Profile) | 風險決策特徵 |\n| :--- | :--- | :--- |\n| **遠期合約 (Forwards)** | **持續上升** | 隨時間推移，不確定性擴大，曝露在到期日達到最高 |\n| **利率互換 (IRS)** | **駝峰型 (Hump)** | 初期隨擴張效應上升，後期因剩餘支付期數減少（攤銷）而下降 |\n| **期權 (Options)** | **不對稱分佈** | 損失有限但收益無限，EE 通常高於對應的遠期合約 |\n\n> [!IMPORTANT]\n> 在三維視覺化中（見 `B2_Ch10_3.py` 和 `B2_Ch10_4.py`），當時間 $t$ 趨近於到期日，PFE 往往會因「攤銷效應」(Amortization Effect) 而歸零。資深風險官必須特別關注「峰值曝露」(Peak Exposure)，這決定了在合約整個生命週期內最容易爆發信用危機的時間點。\n\n#### 10.3 資深從業人員行動清單 (Action Items)\n執行曝露監控時，必須確認：\n- **置信水平與業務對齊**：確保 PFE 使用的 $\\alpha$ (如 95% 或 99%) 與企業內部的限額審批權限完全對位。\n- **展期風險評估**：針對短期滾動合約，評估在 PFE 達到高點時合約展期的流動性成本。\n- **淨額組 (Netting Set) 檢核**：確認 EE 和 PFE 是在同一個淨額組內計算的，而非簡單的單筆合約累加。",
      "10.4": "### 10.4 遠期合約 (Forwards) 的交易對手信用風險：路徑不確定性的線性成長\n遠期合約是 CCR 分析中最基礎的構件。其與互換 (Swap) 不同，遠期合約僅在到期日 (Maturity) 進行單次交割，這意味著其風險曝露在整個生命週期中持續擴張而不發生攤銷。資深從業人員將其視為「累積風險」的典型案例。\n\n#### 技術核心：EE 與 PFE 的解析近似\n對於標的資產為 $S$ 的遠期合約，假設其遵循幾何布朗運動，在時間 $t$ 的預期正曝露 (EE) 可以透過 Black 框架下的解析公式近似。隨著 $t$ 趨近 $T$（到期日），標的價格的方差 $\\sigma^2 t$ 線性增加，導致 PFE 曲線呈現持續向上的坡度。\n\n#### 專家決策矩陣：遠期合約曝露的管理重點\n由於缺乏中期現金流，遠期合約的信用管理需關注末端風險：\n\n| 風險維度 | 特徵描述 | 決策行動 |\n| :--- | :--- | :--- |\n| **到期日曝露峰值** | 曝露在 $T$ 時刻達到最大 | 需要在合約後期大幅增加抵押品撥備 |\n| **隱含波動率敏感度** | $\\sigma$ 增長會顯著抬升 PFE | 對高波動資產的遠期合約需設定更嚴格的信用額度 |\n| **雙向性翻轉** | MtM 正負翻轉頻繁 | 需動態監控是「我方」還是「對方」具備信用風險 |\n\n> [!IMPORTANT]\n> 在生產端實作 `Forward_Exposure()` 時（見 `B2_Ch10_5.py` 的子邏輯），資深開發者會發現遠期合約沒有互換合約的「駝峰效應」。這意味著遠期合約對長期信用限額的占用更為「昂貴」，在資本分配時應優先考慮。若可能，應建議客戶轉換為具備定期結算特性的期貨或互換。\n\n#### 10.4 資深從業人員行動清單 (Action Items)\n執行遠期合約 CCR 評估前，必須確認：\n- **標的資產 $\\sigma$ 校準**：確保隨機路徑模擬使用的波動率與該資產在歷史壓力期的表現一致。\n- **到期結算方式審核**：確認是「實物交割」還是「現金差價結算」，實物交割在到期日可能產生極短暫但巨大的全額本金風險。\n- **CSA 調整頻率**：針對長期遠期合約，應提高保證金呼叫（Margin Call）頻率，以抵消持續擴大的 PFE。",
      "10.5": "### 10.5 利率互換 (IRS) 的交易對手信用風險：駝峰效應的動態解構\n利率互換 (IRS) 的 CCR 與遠期合約顯著不同。其曝露曲線呈現獨特的「駝峰型」(Humped Profile)。這源於兩種相反力量的博弈：隨著時間推移，市場波動導致的潛在損益增加（擴張效應），與剩餘支付期數減少導致的總價值下降（攤銷效應）。資深計量師利用這一特性來優化資本計提。\n\n#### 技術核心：EE 曲線的演化驅動\n1.  **擴張效應 (Diffusion Effect)**：在合約前期，標的利率的隨機遊動範圍擴大，推升 EE。\n2.  **攤銷效應 (Amortization Effect)**：隨著合約接近到期，剩餘資產交換次數減少，潛在曝露強制收斂至零。\n\n#### 專家決策矩陣：均值回歸與波動率的交互決策\n利率模型的選擇直接影響 EE 的峰值位置：\n\n| 模型類型 | EE 峰值位置 | 對風險管理的含義 |\n| :--- | :--- | :--- |\n| **Hull-White (均值回歸)** | 較早出現且峰值較低 | **推薦**：更符合債券市場長期利率回歸的物理特性 |\n| **Black-Karasinski** | 波動性受水平影響 | 適合處理極端低利率或負利率環境下的曝露模擬 |\n| **GBM (忽略回歸)** | 峰值偏後且虛高 | **嚴禁**：會過度高估長期限 IRS 的信用資本要求 |\n\n> [!IMPORTANT]\n> 在 **QuantLib** 實作中（見 `B2_Ch10_5.py`），資深開發者會使用 `PricingEngine` 嵌入蒙地卡羅路徑。必須注意，對沖 IRS 的 CCR 需要同時監控 DV01（利率敏感度）與 CVA Delta。當利率曲線發生平移時，CVA 的變動速度與 IRS 價值的變動速度並不完全同步。\n\n#### 10.5 資深從業人員行動清單 (Action Items)\n執行 IRS 風險分析時，必須落實：\n- **均值回歸速度 $\\alpha$ 校準**：根據歷史數據精確估算 $\\alpha$，這直接決定了 EE 曲線「駝峰」的高度與寬度。\n- **重置日風險審核**：在浮動利率重置日前後，監控 EE 的跳動現象，防止在重置期出現曝露的「假性回歸」。\n- **組合層級抵銷檢驗**：在同一個 Counterparty 下，檢查多筆不同方向 IRS 的 EE 抵銷情況，優化資本使用效率。",
      "10.6": "### 10.6 貨幣互換 (CIRS) 的交易對手信用風險：匯率與利率的雙重共振\n貨幣互換 (Cross-Currency Swap, CIRS) 的 CCR 風險水平遠高於普通利率互換 (IRS)。原因在於 CIRS 在到期日需要交換**外幣本金**。這使得 CIRS 的曝露曲線不再具備顯著的攤銷效應，而是呈現出類似遠期合約與 IRS 的混合體。資深計量師將其標註為「資本高度消耗」產品。\n\n#### 技術核心：本金風險與匯率風險\n1.  **本金交換效應**：合約末端需要歸還大額外幣本金，若匯率發生劇烈波動，曝露量將瞬間飆升。\n2.  **雙重隨機因子**：CIRS 受兩國利率曲線及匯率曲線（FX Spot/Forward）的三重聯動影響，模擬難度呈指數級上升。\n\n#### 專家決策矩陣：CIRS 與 IRS 的風險對比\n資深風險官必須向決策層強調兩者的本質差距：\n\n| 指標 | 利率互換 (IRS) | 貨幣互換 (CIRS) |\n| :--- | :--- | :--- |\n| **末端曝露** | 趨近於零（僅最後一期利息） | **巨大**：包含全額本金交換 |\n| **PFE 形態** | 駝峰型（Humped） | **持續上升型**（或高位徘徊） |\n| **信用點差敏感度** | 中等 | **極高**：信用與匯率的混合敞口 |\n\n> [!IMPORTANT]\n> 在生產端演算法中（見 `B2_Ch10_5.py` 的多維模擬），資深開發者會使用 **Hull-White** 或 **G2++** 模擬雙國利率，並配合 **Garman-Kohlhagen** 模擬匯率。必須注意匯率與利率的「相關性」：在某些市場，本國利率上升往往伴隨本幣升值，這會加劇交易對手的違約損失（錯向風險）。\n\n#### 10.6 資深從業人員行動清單 (Action Items)\n執行 CIRS 曝露分析前，必須落實：\n- **交叉貨幣基礎 (Basis Spread) 校準**：確保模擬引擎考慮了貨幣互換基差，這是匯率風險定價中不可忽略的流動性溢價。\n- **本金重設 (Mark-to-Market Reset) 審度**：確認合約是否具備 MTM 本金重置條款，若有，可顯著降低信用風險，並在模型中正確反應。\n- **國家風險與信用聯動審計**：針對涉及新興市場貨幣的 CIRS，必須評估匯率崩潰與交易對手違約的同步性。",
      "10.7": "### 10.7 信用風險緩釋 (Mitigation)：淨額結算與抵押品管理\n衍生品的信用風險並非不可逾越。資深從業人員透過法律（**淨額結算 Netting**）與合約（**擔保協議 CSA**）工具，能將原始信用風險曝露降低 80% 至 95% 以上。理解這些緩釋工具的邊界與成本，是精確計算「殘餘風險」的前提。\n\n#### 技術核心：緩釋工具的雙重防禦\n1.  **淨額結算 (Netting)**：在 ISDA 框架下，將同一個對手方的所有 ITM（價內）與 OTM（價外）合約相抵銷。$Exposure = \\max(\\sum V_i, 0)$。\n2.  **抵押品與保證金 (Collateral/CSA)**：透過每日交換現金或證券抵押品，將信用曝露控制在「最低轉移金額 (MTA)」之內。\n\n#### 專家決策矩陣：緩釋工具對曝露曲線的影響\n資深分析師需區分「法律抵銷」與「物理抵押」：\n\n| 工具 | 原理 | 對 PFE 曲線的影響 |\n| :--- | :--- | :--- |\n| **淨額結算** | 法律互抵 | 整體下移：降低了不同合約間的加總敞口 |\n| **保證金 (CSA)** | 價值交換 | **封頂效應**：使 PFE 被壓縮在一個窄幅區間內（考量保證金追加期 MPC） |\n| **中央結算 (CCP)** | 成為共同對手 | 風險轉化：將雙邊信用風險轉化為對 CCP 的運營風險 |\n\n> [!IMPORTANT]\n> 在生產端實作 `Netting_Logic()` 時，資深開發者必須嚴格檢查淨額組 (Netting Set) 的 ID。若因編碼錯誤將不同法律實體下的合約強行抵銷，將導致嚴重的風險低估。必須保留「單向曝露」作為壓力測試的基準。\n\n#### 10.7 資深從業人員行動清單 (Action Items)\n執行緩釋效能審計時，必須落實：\n- **ISDA/CSA 合規覆蓋率檢查**：確保存量交易 100% 關聯至有效的法律組件，無「裸露」交易存在。\n- **再抵押風險 (Re-hypothecation) 評估**：確認收到的抵押品是否被允許再次使用，以及在極端流動性危機下的可變現性。\n- **保證金追加期 (MPC) 壓力測試**：考慮在對手違約前 10 個交易日內，市場波動導致的「未覆蓋曝露」激增情況。",
      "10.8": "### 10.8 信用估值調整 (CVA) 與定價：將風險轉化為成本\n**信用估值調整 (Credit Value Adjustment, CVA)** 是 CCR 管理的皇冠珠寶。它代表了衍生品「無違約公允價值」與「考量交易對手信用後真實價值」之間的差額。資深從業人員不再將信用風險視為後台的監控指標，而是將其轉化為前台交易點差（Spread）中的顯性成本。\n\n#### 專家定義：CVA 精算求和公式\nCVA 本質上是交易對手違約導致的折現預期損失。在離散模擬下，其計算公式如下：\n\n$$\n  CVA = (1-R) \\sum_{i=1}^n EE(t_i) \\cdot q(t_{i-1}, t_i) \\cdot DF(t_i)\n$$\n\n- $R$: 回收率 (Recovery Rate)\n- $EE(t_i)$: 預期正曝露 (需在無套利環境下模擬)\n- $q(t_{i-1}, t_i)$: 在該時間段內的違約機率 (PD)\n- $DF(t_i)$: 折現因子\n\n#### 專家決策矩陣：CVA 管理的戰略維度\n資深計量師必須區分 CVA 的兩大職能：\n\n| 決策維度 | 實務目標 | 技術要求 |\n| :--- | :--- | :--- |\n| **估值調整 (Accounting)** | 確保資產負債表記錄真實價值 | 使用市場隱含 (Market-implied) 的 PD 與波動率 |\n| **對沖管理 (Hedging)** | 消除 CVA 波動對損益的影響 | 計算 CVA 的希臘字母（如 CVA Delta, CVA Vega）並動態對沖 |\n| **資本合規 (Capital)** | 滿足監管資本要求 | 依據標準化或高級法計算 CVA RWA |\n\n> [!IMPORTANT]\n> 在生產端 CVA 引擎中（見 `B2_Ch10_5.py`），資深開發者會整合违约曲線 (Default Curve) 與收益率曲線。必须嚴防「錯向風險」(Wrong-Way Risk)，即當標的資產價值飆升（我方盈利）時，交易對手的 PD 也同時飆升，這會導致 CVA 呈指數級增長。\n\n#### 10.8 資深從業人員行動清單 (Action Items)\n佈署 CVA 系統前，必須落實：\n- **違約強度 $\\lambda$ 實時監修**：利用 CDS 點差報價動態更新 $q(t)$，確保 CVA 反映市場最新恐慌情緒。\n- **對沖工具可用性開發**：確認市場上是否存在足夠的 CDS 或債券工具，用以對沖主要交易對手的信用風險。\n- **增量 CVA (Incremental CVA) 測試**：在每一筆新交易進入前，計算其對現有淨額組 CVA 的貢獻。這能引導交易員與信用優質的對手方成交。\n- **數據一致性檢驗**：確保 $EE$ 多步模擬與生存率演算法中的時間網格完全對齊，防止插值引入的數值誤差。\n\n#### 核心技術結論\n交易對手信用風險是金融工程與精算科學的交叉點。透過對 EE、PFE 的動態路徑模擬，以及 CVA 的顯性定價，資深從業人員將不可見的隱性風險轉化為可定價、可對沖且可管理的金融參數矩阵。",
      "10.9": "### 10.9 錯向風險 (Wrong-Way Risk) 分析：相關性的「最後一根稻草」\n在 CCR 管理中，最危險的情況莫過於：當交易對手的違約機率 (PD) 飆升時，我方對其的風險曝露 (Exposure) 也正好達到峰值。這種負面連動被稱為**錯向風險 (Wrong-Way Risk, WWR)**。資深風險官必須特別警惕 WWR，因為它會使 CVA 估值與實際損失之間產生數倍的差距。\n\n#### 技術核心：WWR 的分類與成因\n1.  **特定錯向風險 (Specific WWR)**：源於交易本身的法律或結構聯繫。如：接受交易對手的股票作為其發行之衍生品的抵押品。\n2.  **一般錯向風險 (General WWR)**：源於宏觀經濟因子的聯動。如：當新興市場匯率崩潰時，該國銀行的違約風險與美元遠期合約曝露同步飆升。\n\n#### 專家決策矩陣：識別與應對 WWR\n資深分析師透過情境分析識別隱藏的惡化路徑：\n\n| WWR 類型 | 典型範例 | 管理決策 |\n| :--- | :--- | :--- |\n| **特定型** | 以母公司股票為擔保的貸款 | **嚴禁**：必須立即更換抵押品或關閉頭寸 |\n| **宏觀型** | 外匯賣出期權 vs. 貨幣貶值 | **資本加成**：在 PFE 基礎上額外計提 20%-50% 的 Alpha 乘數 |\n| **反向 (Right-Way)** | 商品生產者賣出商品遠期 | **激進擴張**：信用與曝露反向，屬於自然對沖，可放寬限額 |\n\n> [!IMPORTANT]\n> 在生產端 CVA 模擬中（見 `B2_Ch10_5.py` 的擴展模組），資深開發者會使用 **Copula** 函數來建模 $PD$ 與 $Exposure$ 的耦合關係。必須監控「相關性崩塌」：在平時 $\\rho = 0.2$ 的變數，在危機中可能趨近 $1.0$。若模型忽略此動態，CVA 將完全失效。\n\n#### 10.9 資深從業人員行動清單 (Action Items)\n執行 WWR 專項稽核前，必須確認：\n- **抵押品與對手方相關性矩陣**：檢查是否存在「以己之矛，衛己之盾」的邏輯陷阱，嚴格執行抵押品池隔離。\n- **宏觀壓力因子對齊**：在壓力測試情境中，強制設定 PD 與匯率/利率因子的相關係數為正向（保守假設）。\n- **集中度風險校準**：針對特定行業的集中曝露，評估該行業週期與企業違約的同步性。"
    },
    "examples": [
      {
        "id": "ex1",
        "title": "10.1 PDF 繪製與 EE, PFE 分析",
        "filename": "B2_Ch10_1.py",
        "code": "# B2_Ch10_1.py\n\n###############\n# Prepared by Ran An, Wei Lu, and Feng Zhang\n# Editor-in-chief: Weisheng Jiang, and Sheng Tu\n# Book 2  |  Financial Risk Management with Python\n# Published and copyrighted by Tsinghua University Press\n# Beijing, China, 2021\n###############\n\nimport numpy as np\nimport matplotlib.pyplot as plt\nfrom scipy.stats import norm\nimport scipy.stats as stats\n\n# parameters\nmu = 3.0 \nsigma = 5.0\nalpha = 0.97\n\n# generate normal distribution\nx1 = mu-20\nx2 = mu+20\nx = np.arange(x1, x2, 0.001)\ny = norm.pdf(x, mu, sigma)\n\n# calculate EE and PFE\nEE = mu*stats.norm.cdf(mu/sigma) + sigma*stats.norm.pdf(mu/sigma)\nPFE = mu + sigma*stats.norm.ppf(alpha)\nprint(' EE: ', round(EE,2)) \nprint(' PFE: ', round(PFE,2))\n\n# plot and identify EE PFE\nfig, ax = plt.subplots(figsize=(9, 6))\nax.plot(x, y)\n\n# fill exposure area\nx0 = np.arange(0, x2, 0.001)\ny0 = norm.pdf(x0, mu, sigma)\nax.fill_between(x0, y0, 0, color='moccasin')\nax.fill_between(x, y, 0, alpha=0.5, color='palegreen')\n\n# draw vertical line to identify mu, EE and PFE\nax.vlines(mu, 0, norm.pdf(mu, mu, sigma), linestyles =\"dashed\", colors =\"#B7DEE8\", label='$\\\\mu$')\nax.vlines(EE, 0, norm.pdf(EE, mu, sigma), linestyles =\"dashed\", colors =\"#0070C0\", label='EE')\nax.vlines(PFE, 0, norm.pdf(PFE, mu, sigma), linestyles =\"dashed\", colors =\"#3C9DFF\", label='PFE')\n\n# add x ticks to mu, EE and PFE\nfig.canvas.draw()\nlabels = [w.get_text() for w in ax.get_xticklabels()]\nlocs = list(ax.get_xticks())\nlabels += ['$\\\\mu$', '$EE$', '$PFE$']\nlocs += [mu, EE, PFE]\nax.set_xticks(locs) \nax.set_xticklabels(labels)\n\n# add lables and title\nax.set_xlabel('MtM')\nax.set_ylabel('Probability')\nax.set_title('EE and PFE for a Normal Distribution')\nax.spines['right'].set_visible(False)\nax.spines['top'].set_visible(False)\nax.yaxis.set_ticks_position('left')\nax.xaxis.set_ticks_position('bottom')\n"
      },
      {
        "id": "ex2",
        "title": "10.2 多子圖佈局與風險數據對比",
        "filename": "B2_Ch10_2.py",
        "code": "# B2_Ch10_2.py\n\n###############\n# Prepared by Ran An, Wei Lu, and Feng Zhang\n# Editor-in-chief: Weisheng Jiang, and Sheng Tu\n# Book 2  |  Financial Risk Management with Python\n# Published and copyrighted by Tsinghua University Press\n# Beijing, China, 2021\n###############\n\nimport numpy as np\nimport matplotlib.pyplot as plt\nimport pandas as pd\n\ndf = pd.read_csv(r'C:\\Users\\anran\\Dropbox\\FRM Book\\CCR\\EE.csv')\n\neffective_ee = []\neffective_ee.append(df['EE'].iloc[0]) \nfor i in range(1, len(df.index)):\n    effective_ee.append(max(effective_ee[i-1], df['EE'].iloc[i]))\n\n# Effective EE    \ndf['Effective EE'] = effective_ee\n# calculate EPE\nepe = np.mean(df['EE'])\n# calculate Effective EPE\neffective_epe = np.mean(df['Effective EE'])\n\n# plot\nfig, ax = plt.subplots(figsize=(10, 6))\nax.plot(df['Time'], df['EE'], '-o', label='EE')\nax.plot(df['Time'], df['Effective EE'], '-o', label='Effective EE')\nax.hlines(epe, 0, 1, linestyles =\"dashed\", colors =\"#0070C0\", label='EPE')\nax.hlines(effective_epe, 0, 1, linestyles =\"dashed\", colors =\"#3C9DFF\", label='Effective EPE')\nax.legend()\n\n# add lables and title\nax.set_xlabel('Time')\nax.set_ylabel('Exposure')\nax.set_xlim([0.0, 1.0])\nax.set_ylim([0.0, 1.0])\nax.set_title('EE, Effective EE, EPE and Effective EPE')\nax.spines['right'].set_visible(False)\nax.spines['top'].set_visible(False)\nax.yaxis.set_ticks_position('left')\nax.xaxis.set_ticks_position('bottom')\n"
      },
      {
        "id": "ex3",
        "title": "10.3 基礎風險因子統計分佈曲線",
        "filename": "B2_Ch10_3.py",
        "code": "# B2_Ch10_3.py\n\n###############\n# Prepared by Ran An, Wei Lu, and Feng Zhang\n# Editor-in-chief: Weisheng Jiang, and Sheng Tu\n# Book 2  |  Financial Risk Management with Python\n# Published and copyrighted by Tsinghua University Press\n# Beijing, China, 2021\n###############\n\nimport numpy as np\nimport matplotlib.pyplot as plt\nfrom scipy.stats import norm\n\n# parameters\ndrift = 0.05\nvol = 0.10\nconfidence_level = 0.99\nT = 5\n\n# calculate pfe\nt = np.arange(0.0, T, 0.01)\nforward_pfe = drift*t+vol*np.sqrt(t)*norm.ppf(confidence_level)\n\n# plot\nplt.style.use('fast')\nplt.plot(t, forward_pfe)\nplt.grid(True)\nplt.xlabel(\"Time in years\")\nplt.ylabel(\"PFE\")\nplt.title(\"PFE Evolution -- Forward\")\nplt.grid(None)  \nplt.gca().spines['right'].set_visible(False)\nplt.gca().spines['top'].set_visible(False)\nplt.gca().yaxis.set_ticks_position('left')\nplt.gca().xaxis.set_ticks_position('bottom')\n"
      },
      {
        "id": "ex4",
        "title": "10.4 數據直方圖與擬合優度",
        "filename": "B2_Ch10_4.py",
        "code": "# B2_Ch10_4.py\n\n###############\n# Prepared by Ran An, Wei Lu, and Feng Zhang\n# Editor-in-chief: Weisheng Jiang, and Sheng Tu\n# Book 2  |  Financial Risk Management with Python\n# Published and copyrighted by Tsinghua University Press\n# Beijing, China, 2021\n###############\n\nimport numpy as np\nimport matplotlib.pyplot as plt\nfrom scipy.stats import norm\n\n# parameters\ninterest_rate_vol = 0.005\nconfidence_level = 0.99\nT = 25.0\n\n# calcualte pfe\nt = np.arange(0.0, T, 0.05)\nirs_pfe = interest_rate_vol*np.sqrt(t)*(T-t)*norm.ppf(confidence_level)\n\n# plot\nplt.style.use('fast')\nplt.plot(t, irs_pfe)\nplt.xlabel(\"Time in years\")\nplt.ylabel(\"PFE\")\nplt.title(\"PFE Evolution -- Interest Rate Swap\")\nplt.gca().spines['right'].set_visible(False)\nplt.gca().spines['top'].set_visible(False)\nplt.gca().yaxis.set_ticks_position('left')\nplt.gca().xaxis.set_ticks_position('bottom')\n"
      },
      {
        "id": "ex5",
        "title": "10.5 QuantLib 蒙地卡羅與 CVA 計算",
        "filename": "B2_Ch10_5.py",
        "code": "# B2_Ch10_5.py\n\n###############\n# Prepared by Ran An, Wei Lu, and Feng Zhang\n# Editor-in-chief: Weisheng Jiang, and Sheng Tu\n# Book 2  |  Financial Risk Management with Python\n# Published and copyrighted by Tsinghua University Press\n# Beijing, China, 2021\n###############\n\n# B2_Ch10_5_A.py \n# import libraries\nimport numpy as np\nimport matplotlib.pyplot as plt\nimport QuantLib as ql\n\n# set evaluation date\ntoday = ql.Date(15,10,2020)\nql.Settings.instance().setEvaluationDate = today\n\n# set Marketdata\nrate = ql.SimpleQuote(0.025)\nrate_handle = ql.QuoteHandle(rate)\ndc = ql.Actual365Fixed()\ncrv = ql.FlatForward(today, rate_handle, dc)\ncrv.enableExtrapolation()\nyts = ql.YieldTermStructureHandle(crv)\nhyts = ql.RelinkableYieldTermStructureHandle(crv)\nindex = ql.Euribor6M(hyts)\n\n\n\n# B2_Ch10_5_B.py\n# set a swap\nstart = today + ql.Period(\"2d\")\nmaturity = ql.Period(\"4Y\")\nend = ql.TARGET().advance(start, maturity)\nnominal = 3e8\nfixedRate = 0.025\ntyp = ql.VanillaSwap.Receiver\nspread = 0.0\n\nfixedSchedule = ql.Schedule(start,\n                            end, \n                            ql.Period(\"1y\"), \n                            index.fixingCalendar(), \n                            ql.ModifiedFollowing,\n                            ql.ModifiedFollowing, \n                            ql.DateGeneration.Backward,\n                            False)\nfloatSchedule = ql.Schedule(start,\n                            end,\n                            index.tenor(),\n                            index.fixingCalendar(),\n                            index.businessDayConvention(),\n                            index.businessDayConvention(),\n                            ql.DateGeneration.Backward,\n                            False)\nswap = ql.VanillaSwap(typ, \n                      nominal,\n                      fixedSchedule,\n                      fixedRate,\n                      ql.Thirty360(ql.Thirty360.BondBasis),\n                      floatSchedule,\n                      index,\n                      spread,\n                      index.dayCounter())\n\n# pricing engine and npv\nengine = ql.DiscountingSwapEngine(hyts)\nswap.setPricingEngine(engine)\nswap.NPV()\nprint(swap.NPV())\n\n\n\n# B2_Ch10_5_C.py \n# model parameters\nvol = [ql.QuoteHandle(ql.SimpleQuote(0.008)),\n         ql.QuoteHandle(ql.SimpleQuote(0.008))]\nmeanRev = [ql.QuoteHandle(ql.SimpleQuote(0.04)),\n           ql.QuoteHandle(ql.SimpleQuote(0.04))]\nmodel = ql.Gsr(yts, [today+365], vol, meanRev) \nprocess = model.stateProcess()\n\n\n\n# B2_Ch10_5_D.py \n# evaluation time grid\ndate_grid = [today + ql.Period(i,ql.Months) for i in range(0,12*5)]\nfixingDate = [index.fixingDate(x) for x in floatSchedule][:-1]\ndate_grid += fixingDate\ndate_grid = np.unique(np.sort(date_grid))\ntime_grid = np.vectorize(lambda x: ql.ActualActual().yearFraction(today, x))(date_grid)\ndt = time_grid[1:] - time_grid[:-1]\n\n\n\n# B2_Ch10_5_E.py \n# random number generator\nseed = 666\nurng = ql.MersenneTwisterUniformRng(seed)\nusrg = ql.MersenneTwisterUniformRsg(len(time_grid)-1,urng)\nrn_generator = ql.InvCumulativeMersenneTwisterGaussianRsg(usrg)\n\n# MC simulations\nsim_num = 1000\n# --- added by limit_simulations.py: apply cap 1000\n__SIM_CAP = 1000\ntry:\n    if sim_num > __SIM_CAP:\n        print('Reducing sim_num from', sim_num, 'to', __SIM_CAP, 'to avoid heavy computation.')\n        sim_num = __SIM_CAP\nexcept Exception:\n    pass\n\nx = np.zeros((sim_num, len(time_grid)))\ny = np.zeros((sim_num, len(time_grid)))\npillars = np.array([0.0, 0.5, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10])\nzero_bonds = np.zeros((sim_num, len(time_grid), len(pillars)))\n\nfor j in range(len(pillars)):\n    zero_bonds[:, 0, j] = model.zerobond(pillars[j],0,0)\n    \nfor n in range(0,sim_num):\n    dWs = rn_generator.nextSequence().value()\n    for i in range(1, len(time_grid)):\n        t0 = time_grid[i-1]\n        t1 = time_grid[i]\n        x[n,i] = process.expectation(t0,x[n,i-1],dt[i-1]) + dWs[i-1] * process.stdDeviation(t0,x[n,i-1],dt[i-1])\n        y[n,i] = (x[n,i] - process.expectation(0,0,t1)) / process.stdDeviation(0,0,t1)\n        for j in range(len(pillars)):\n            zero_bonds[n, i, j] = model.zerobond(t1+pillars[j],t1,y[n, i])\n\n# plot the paths\nplt.style.use('ggplot')\nfor i in range(0,sim_num):\n    plt.plot(time_grid, x[i,:])\nplt.xlabel(\"Time in years\")\nplt.ylabel(\"Zero rate\")\nplt.title(\"Monte Carlo simulation\")    \n\n\n\n# B2_Ch10_5_F.py \n# swap pricing\nnpv_cube = np.zeros((sim_num,len(date_grid)))\nfor p in range(0,sim_num):\n    for t in range(0, len(date_grid)):\n        date = date_grid[t]\n        ql.Settings.instance().setEvaluationDate(date)\n        ycDates = [date,date + ql.Period(6, ql.Months)] \n        ycDates += [date + ql.Period(i,ql.Years) for i in range(1,11)]\n        yc = ql.DiscountCurve(ycDates, \n                              zero_bonds[p, t, :], \n                              ql.Actual365Fixed())\n        yc.enableExtrapolation()\n        hyts.linkTo(yc)\n        if index.isValidFixingDate(date):\n            fixing = index.fixing(date)\n            index.addFixing(date, fixing)\n        npv_cube[p, t] = swap.NPV()\n    ql.IndexManager.instance().clearHistories()\nql.Settings.instance().setEvaluationDate(today)\nhyts.linkTo(crv)\n\n# alculate credit exposure\nexposure = npv_cube.copy()\nexposure[exposure<0]=0\n\n# plot first 15 NPV and exposure paths\nfig, (ax1, ax2) = plt.subplots(2, 1)\nfor i in range(0,15):\n    ax1.plot(time_grid, npv_cube[i,:])\nfor i in range(0,15):\n    ax2.plot(time_grid, exposure[i,:])\nax1.set_xlabel(\"Time in years\")\nax1.set_ylabel(\"NPV\")\nax1.set_title(\"(a) First 15 simulated npv paths\")\nax2.set_xlabel(\"Time in years\")\nax2.set_ylabel(\"Exposure\")\nax2.set_title(\"(b) First 15 simulated exposure paths\")\nplt.tight_layout()\n\n\n\n# B2_Ch10_5_G.py \n# Calculate expected exposure\nee = np.sum(exposure, axis=0)/sim_num\n# Calculate PFE curve (95% quantile)\nPFE_curve = np.apply_along_axis(lambda x: np.sort(x)[int(0.95*sim_num)],0,exposure)\n# plot expected exposure and PFE\nfig, (ax1, ax2) = plt.subplots(2, 1)\nax1.plot(time_grid, ee)\nax1.set_xlabel(\"Time in years\")\nax1.set_ylabel(\"Expected Exposure\")\nax1.set_title(\"(a) Expected Exposure\")\nax2.plot(time_grid,PFE_curve)\nax2.set_xlabel(\"Time in years\")\nax2.set_ylabel(\"PFE\")\nax2.set_title(\"(b) PFE\")\nplt.tight_layout()\n\n\n\n# B2_Ch10_5_H.py \n# generate the discount factors\ndiscount_factors = np.vectorize(yts.discount)(time_grid)\n# calculate discounted npvs\ndiscounted_cube = np.zeros(npv_cube.shape)\ndiscounted_cube = npv_cube * discount_factors\n# calculate discounted exposure\ndiscounted_exposure = discounted_cube.copy()\ndiscounted_exposure[discounted_exposure<0] = 0\n# calculate discounted expected exposure\ndiscounted_ee = np.sum(discounted_exposure, axis=0)/sim_num\n\n# plot discounted npv and exposure\nfig, (ax1, ax2) = plt.subplots(2, 1)\nfor i in range(0,15):\n    ax1.plot(time_grid, discounted_cube[i,:])\nfor i in range(0,15):\n    ax2.plot(time_grid, discounted_exposure[i,:])\nax1.set_xlabel(\"Time in years\")\nax1.set_ylabel(\"Discounted npv\")\nax1.set_title(\"(a) First 15 simulated discounted npv paths\")\nax2.plot(time_grid,discounted_ee)\nax2.set_xlabel(\"Time in years\")\nax2.set_ylabel(\"Discounted exposure\")\nax2.set_title(\"(b) First 15 simulated discounted exposure paths\")\nplt.tight_layout()\n\n\n\n# B2_Ch10_5_I.py \n# plot discounted expected exposure\nfig, ax1 = plt.subplots(1, 1)\nax1.plot(time_grid,discounted_ee)\nax1.set_xlabel(\"Time in years\")\nax1.set_ylabel(\"Discounted expected exposure\")\nax1.set_title(\"(b) Discounted expected exposure\")\n\n\n\n# B2_Ch10_5_J.py \n# build default curve \npd_dates =  [today + ql.Period(i, ql.Years) for i in range(11)]\nhzrates = [0.03 * i for i in range(11)]\npd_curve = ql.HazardRateCurve(pd_dates,hzrates,ql.Actual365Fixed())\npd_curve.enableExtrapolation()\n# calculate default probs on grid and plot curve\ntimes = np.linspace(0,25,100)\ndp = np.vectorize(pd_curve.defaultProbability)(times)\nsp = np.vectorize(pd_curve.survivalProbability)(times)\ndd = np.vectorize(pd_curve.defaultDensity)(times)\nhr = np.vectorize(pd_curve.hazardRate)(times)\nf, ((ax1, ax2), (ax3, ax4)) = plt.subplots(2, 2)\nax1.plot(times, dp)\nax2.plot(times, sp)\nax3.plot(times, dd)\nax4.plot(times, hr)\nax1.set_xlabel(\"Time in years\")\nax2.set_xlabel(\"Time in years\")\nax3.set_xlabel(\"Time in years\")\nax4.set_xlabel(\"Time in years\")\nax1.set_ylabel(\"Probability\")\nax2.set_ylabel(\"Probability\")\nax3.set_ylabel(\"Density\")\nax4.set_ylabel(\"Hazard rate\")\nax1.set_title(\"Default probability\")\nax2.set_title(\"Survival probability\")\nax3.set_title(\"Default density\")\nax4.set_title(\"Hazard rate\")\n\n\n\n# B2_Ch10_5_K.py \n# calculate default probs\nPD_vec = np.vectorize(pd_curve.defaultProbability)\ndPD = PD_vec(time_grid[:-1], time_grid[1:])\n# calculate CVA\nRR = 0.4\nCVA = (1-RR) * np.sum(discounted_ee[1:] * dPD)\nprint (\"CVA value: %.2f\" % CVA)"
      },
      {
        "id": "ex6",
        "title": "10.6 偏態與峰態對風險分佈的影響",
        "filename": "B2_Ch10_6.py",
        "code": "# B2_Ch10_6.py\n\n###############\n# Prepared by Ran An, Wei Lu, and Feng Zhang\n# Editor-in-chief: Weisheng Jiang, and Sheng Tu\n# Book 2  |  Financial Risk Management with Python\n# Published and copyrighted by Tsinghua University Press\n# Beijing, China, 2021\n###############\n\nimport numpy as np\nimport matplotlib.pyplot as plt\nfrom scipy.stats import norm\n\nir_vol = 0.005\nfx_vol = 0.05\ncorrelation = 0.20\nconfidence_level = 0.99\nT = 5\n\nt = np.arange(0.0, T, 0.01)\nirs_pfe = ir_vol*np.sqrt(t)*(T-t)*norm.ppf(confidence_level)\nforward_pfe = fx_vol*np.sqrt(t)*norm.ppf(confidence_level)\nccs_pfe = np.sqrt(irs_pfe*irs_pfe+forward_pfe*forward_pfe+2.0*correlation*irs_pfe*forward_pfe)\n\nplt.style.use('fast')\nplt.plot(t, irs_pfe, c='lightblue', label='IRS')\nplt.plot(t, forward_pfe, c='dodgerblue', label='FX Forward')\nplt.plot(t, ccs_pfe, c='red', label='CCS')\n\nplt.xlabel(\"Time in years\")\nplt.ylabel(\"PFE\")\nplt.title(\"PFE Evolution\")\nplt.legend()\nplt.gca().spines['right'].set_visible(False)\nplt.gca().spines['top'].set_visible(False)\nplt.gca().yaxis.set_ticks_position('left')\nplt.gca().xaxis.set_ticks_position('bottom')\n"
      }
    ]
  }
}